<!--
Sync Impact Report
- Version change: 1.2.2 -> 1.3.0
- Modified principles:
  - Development Workflow and Delivery Gates (добавлены обязательные MCP-oriented шаги для multi-module задач)
- Added sections:
  - VI. MCP-First Context, File-First Truth
  - MCP Operational Policy
- Removed sections:
  - None
- Templates requiring updates:
  - ✅ updated: .specify/templates/plan-template.md
  - ✅ updated: .specify/templates/spec-template.md
  - ✅ updated: .specify/templates/tasks-template.md
  - ⚠ pending: .specify/templates/commands/*.md (directory is missing in current repository)
  - ✅ updated: README.md
  - ✅ updated: docs/quickstart.md
- Follow-up TODOs:
  - TODO(COMMAND_TEMPLATES): if Speckit command templates are later added at
    .specify/templates/commands/*.md, localize them to Russian and align them
    with this constitution.
-->
# ndlss-memory Constitution

## Core Principles

### I. Docker Compose Reproducibility
Все обязательные компоненты проекта ДОЛЖНЫ запускаться одной командой
`docker compose up` без локальной установки зависимостей, кроме Docker и Git.
Состав сервисов фиксирован: `qdrant`, `file-indexer`, `mcp-server`.
Каждый сервис ДОЛЖЕН иметь стабильные `healthcheck`, предсказуемые переменные
окружения и документированные volume-монты.
Рационал: воспроизводимость и простой запуск для любого пользователя.

### II. Deterministic File Indexing
`file-indexer` ДОЛЖЕН работать как минимум в двух режимах:
`full-scan` (полная индексация) и `delta-after-commit` (только измененные файлы
после commit). Типы индексируемых файлов ДОЛЖНЫ задаваться через конфиг или
переменные окружения, а не кодом. Индексация ДОЛЖНА быть идемпотентной:
повторный запуск без изменений не создает дубликатов в векторном хранилище.
Рационал: предсказуемое качество индекса и контролируемая стоимость обработки.

### III. Secure MCP Interoperability
`mcp-server` ДОЛЖЕН предоставлять интерфейс, совместимый с MCP, чтобы им могла
пользоваться любая модель или агент. Все инструменты MCP ДОЛЖНЫ иметь четкие
контракты ввода/вывода, машиночитаемые ошибки и таймауты. Запуск команд ДОЛЖЕН
быть ограничен allowlist-политикой, изоляцией контейнера и запретом на
неограниченный доступ к хост-системе.
Рационал: совместимость между провайдерами ИИ без компромисса по безопасности.

### IV. Quality Gates and Test Discipline
Каждое изменение ДОЛЖНО проходить минимум четыре проверки:
1. unit/integration тесты для затронутой логики;
2. проверка Docker Compose запуска с нуля;
3. проверка MCP-контрактов (инструменты отвечают по спецификации);
4. проверка отсутствия регрессий индексации в обоих режимах.
Изменение нельзя считать завершенным, пока все обязательные проверки не пройдены.
Рационал: стабильность поставки важнее скорости без верификации.

### V. Documentation as a Product
Проект ДОЛЖЕН поддерживать актуальные `README.md`, quickstart, примеры
конфигурации и описание ограничений безопасности. Любое изменение публичного
поведения ДОЛЖНО сопровождаться обновлением документации в том же PR.
Документация ДОЛЖНА быть понятной внешнему пользователю GitHub без контекста
внутренней команды.
Рационал: для open-source проекта документация является частью продукта.

### VI. MCP-First Context, File-First Truth
MCP ДОЛЖЕН использоваться как основной слой навигации и retrieval-контекста
(обзор репозитория, поиск по docs/code, быстрый сбор связанного контекста).
При этом источником истины для изменений ДОЛЖНЫ оставаться реальные файлы
workspace и результаты локальных тестов/скриптов. Любое решение, принятое на
основе MCP-выдачи, ДОЛЖНО быть подтверждено прямым чтением соответствующих
файлов перед внесением изменений.
Рационал: MCP ускоряет анализ, но финальная корректность определяется кодом и
тестами.

## Architecture and Operational Constraints

1. Архитектура ограничена тремя сервисами: `qdrant`, `file-indexer`, `mcp-server`.
2. `qdrant` ДОЛЖЕН использовать persistent volume для сохранения индекса между
перезапусками.
3. `file-indexer` ДОЛЖЕН читать файлы через volume из рабочей директории и уважать
исключения (`.git`, бинарные артефакты, секреты).
4. `mcp-server` ДОЛЖЕН запрашивать данные через явные API/контракты, а не через
непрозрачный доступ к внутреннему состоянию контейнеров.
5. Все сетевые порты, лимиты ресурсов и политики рестарта ДОЛЖНЫ быть явными в
`docker-compose.yml`.

## MCP Operational Policy

1. Для локальной разработки MCP-стек ДОЛЖЕН запускаться на уникальных портах,
чтобы не конфликтовать с другими проектами/стеками.
2. Перед началом работы агент ДОЛЖЕН проверить:
`/health`, `/.well-known/mcp`, `/v1/system/config`.
3. Если docs-коллекция пуста, ДОЛЖЕН выполняться docs-only indexing перед
использованием docs search в задачах анализа/планирования.
4. `readiness` ДОЛЖЕН интерпретироваться отдельно от `health`: `/health=ok`
означает доступность API, а `/v1/system/startup/readiness` отражает строго
состояние bootstrap-процесса.
5. Для release/quality-gate сценариев bootstrap ДОЛЖЕН завершаться без ошибок
(`completed`, без деградации по failed chunks). Для dev-исследования
допускается ограниченный partial-статус при сохранении работоспособности
search-инструментов.
6. Профили окружения MCP (порты, лимиты, коллекции, режим индексации) ДОЛЖНЫ
храниться в явном env-файле проекта и быть воспроизводимыми.

## Development Workflow and Delivery Gates

1. Перед реализацией изменений ДОЛЖНЫ быть обновлены `spec.md`, `plan.md` и
`tasks.md` для соответствующей фичи.
2. PR ДОЛЖЕН содержать: ссылку на спецификацию, список затронутых сервисов,
результаты тестов и изменения документации.
3. Если изменение затрагивает MCP-инструменты или формат индекса, ДОЛЖЕН быть
описан план миграции и обратная совместимость.
4. Любое ослабление требований этой конституции требует явного исключения в PR с
обоснованием и сроком устранения.
5. После завершения implementation ДОЛЖНЫ быть явно отмечены выполненные пункты
в пользовательских roadmap/checklist-артефактах (например, в `README.md`,
`tasks.md`, release-checklist), если они затронуты изменением.
6. Новые feature-ветки и директории в `specs/` ДОЛЖНЫ использовать глобальную
возрастающую трехзначную нумерацию по репозиторию (`001`, `002`, `003`, ...),
без повторного старта с `001` для нового short-name.
7. Перед созданием новой feature-ветки ДОЛЖЕН выполняться единый алгоритм
вычисления номера:
   - получить актуальные remote-ветки (`git fetch --all --prune`);
   - собрать все feature-номера из трех источников:
     remote branches, local branches, `specs/[0-9]+-*`;
   - извлечь глобальный максимальный номер `N` из всех найденных значений;
   - использовать только `N+1`;
   - при отсутствии любых feature-веток/спек использовать `001`.
   Любой дубль номера (включая повторный `001`) считается нарушением
   quality gates и подлежит немедленному исправлению до продолжения работы.
8. Все Markdown-файлы (`*.md`) ДОЛЖНЫ сохраняться в кодировке UTF-8.
Файлы в UTF-16/ANSI считаются нарушением quality gates и подлежат исправлению в
том же изменении.
9. Для задач, затрагивающих более одного модуля/подсистемы, агент ДОЛЖЕН
сначала выполнить MCP-контекстный проход: docs search -> semantic search ->
точечное чтение исходников.
10. MCP-инструменты ДОЛЖНЫ применяться по назначению: `search_docs` для
документации и продуктовых требований, `semantic_search` для кодовых связей,
`get_source_by_id`/`get_metadata_by_id` для верификации найденного фрагмента.
11. Перед редактированием файлов результаты MCP-поиска ДОЛЖНЫ быть подтверждены
локальными средствами (`rg`, прямое чтение файлов).
12. Если MCP-индекс устарел или неполон для текущей задачи, агент ДОЛЖЕН
инициировать обновление индекса и только после этого продолжать анализ.
13. При расхождении между MCP-выдачей и фактическим содержимым файлов приоритет
ДОЛЖЕН отдаваться файлам в репозитории; расхождение ДОЛЖНО быть зафиксировано
в комментарии к задаче/PR.

## Governance

Эта конституция имеет приоритет над локальными практиками и шаблонами.
Изменения принимаются только через PR с отдельным разделом `Constitution Impact`.
Порядок изменения версий:
- MAJOR: удаление принципа, несовместимое изменение governance или обязательных
quality gates;
- MINOR: добавление нового принципа/раздела или существенное расширение требований;
- PATCH: редакционные правки без изменения нормативного смысла.

Проверка соблюдения проводится для каждого PR и релиза:
- reviewer обязан проверить соответствие принципам и quality gates;
- отсутствие подтверждения compliance блокирует merge;
- обнаруженные нарушения фиксируются как отдельные задачи с дедлайном.

**Version**: 1.3.0 | **Ratified**: 2026-02-21 | **Last Amended**: 2026-02-23
