# Спецификация фичи: [FEATURE NAME]

**Feature Branch**: `[###-feature-name]`
**Created**: [DATE]
**Status**: Draft
**Input**: User description: "$ARGUMENTS"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - [Краткий заголовок] (Priority: P1)

[Опишите пользовательский путь простым языком]

**Why this priority**: [Почему это самый важный инкремент]

**Independent Test**: [Как проверить ценность истории изолированно]

**Acceptance Scenarios**:

1. **Given** [начальное состояние], **When** [действие], **Then** [результат]
2. **Given** [начальное состояние], **When** [действие], **Then** [результат]

---

### User Story 2 - [Краткий заголовок] (Priority: P2)

[Описание]

**Why this priority**: [Обоснование]

**Independent Test**: [Изолированная проверка]

**Acceptance Scenarios**:

1. **Given** [начальное состояние], **When** [действие], **Then** [результат]

---

### User Story 3 - [Краткий заголовок] (Priority: P3)

[Описание]

**Why this priority**: [Обоснование]

**Independent Test**: [Изолированная проверка]

**Acceptance Scenarios**:

1. **Given** [начальное состояние], **When** [действие], **Then** [результат]

---

### Edge Cases

- Что происходит при пустой директории индексации?
- Что происходит при неподдерживаемом типе файла?
- Как система ведет себя при повторной индексации без изменений?
- Что делает `mcp-server` при таймауте или ошибке внешнего инструмента?
- Как обрабатывается попытка запуска команды вне allowlist?
- Как пользователю интерпретировать `health=ok` при `startup/readiness != ready`?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST запускать стек через `docker compose up` с сервисами
  `qdrant`, `file-indexer`, `mcp-server`.
- **FR-002**: `file-indexer` MUST поддерживать режимы `full-scan` и
  `delta-after-commit`.
- **FR-003**: Система MUST конфигурировать индексируемые типы файлов через
  параметры/переменные окружения.
- **FR-004**: Повторная индексация без изменений MUST не создавать дубликаты
  в Qdrant.
- **FR-005**: `mcp-server` MUST предоставлять совместимые MCP-инструменты с
  формализованным вводом/выводом и машиночитаемыми ошибками.
- **FR-006**: Запуск команд MUST быть ограничен allowlist, таймаутом и
  контейнерной изоляцией.
- **FR-007**: Все изменения публичного поведения MUST обновлять документацию
  (`README.md`, quickstart, примеры конфигурации).
- **FR-008**: API MUST явно разделять операционные статусы доступности
  (`/health`) и готовности bootstrap (`/v1/system/startup/readiness`).
- **FR-009**: Docs-only поиск MUST выполняться по отдельной docs-коллекции; при
  пустой docs-коллекции сценарий bootstrap/первичной индексации MUST быть
  явно определен.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: `docker compose up` на чистой машине должен завершаться без
  ручной установки зависимостей, кроме Docker.
- **NFR-002**: Все сервисы должны иметь `healthcheck` и детерминированные логи.
- **NFR-003**: Ошибки MCP-инструментов должны быть наблюдаемыми и пригодными
  для автоматического разбора.
- **NFR-004**: Для локальной разработки должны быть поддержаны уникальные
  host-порты для одновременного запуска нескольких стеков без конфликтов.

### Key Entities *(include if feature involves data)*

- **IndexedFile**: путь, хеш контента, тип файла, время индексации, статус.
- **EmbeddingRecord**: идентификатор вектора, ссылка на файл/фрагмент,
  метаданные источника.
- **McpToolCall**: имя инструмента, входные параметры, результат, код ошибки,
  длительность.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Новый пользователь запускает стек и получает рабочий ответ MCP
  не более чем за 10 минут по инструкции из `README.md`.
- **SC-002**: В режиме `full-scan` индексируются 100% поддерживаемых файлов из
  тестового набора без падений.
- **SC-003**: В режиме `delta-after-commit` повторная индексация изменяет только
  затронутые файлы и не дублирует записи.
- **SC-004**: 95% вызовов MCP-инструментов завершаются в пределах целевого SLA,
  определенного в плане.

