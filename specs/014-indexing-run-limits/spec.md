# Спецификация фичи: Ограничение глубины и объема индексации

**Feature Branch**: `[014-indexing-run-limits]`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "Add traversal depth and max-files limits to indexing runs. Goal: Control indexing blast radius and runtime cost in large repositories."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Контроль масштаба одного запуска (Priority: P1)

Оператор задает лимиты глубины обхода и максимального числа файлов на запуск, чтобы индексатор не выходил за ожидаемый объем работ в большом репозитории.

**Why this priority**: Это напрямую ограничивает blast radius и стоимость запуска индексации, что является основной бизнес-целью фичи.

**Independent Test**: Запустить индексацию на репозитории, где число и глубина файлов превышают заданные лимиты, и проверить, что обработка не выходит за ограничения.

**Acceptance Scenarios**:

1. **Given** задан лимит глубины, **When** запуск индексации доходит до файлов глубже лимита, **Then** эти файлы не попадают в обработку текущего запуска.
2. **Given** задан лимит количества файлов, **When** количество подходящих файлов превышает лимит, **Then** в запуск попадает не более заданного числа файлов.

---

### User Story 2 - Единые правила в разных режимах индексации (Priority: P2)

Оператор ожидает, что ограничение глубины и количества файлов работает одинаково во всех релевантных путях индексации, чтобы поведение было предсказуемым.

**Why this priority**: Без единого поведения операционные правила трудно применять и проверять в рабочих сценариях.

**Independent Test**: Выполнить индексацию в полном режиме и в релевантном ingestion-пути при одинаковых лимитах и убедиться, что ограничения применяются одинаково.

**Acceptance Scenarios**:

1. **Given** одинаковые входные данные и одинаковые лимиты, **When** запускаются разные релевантные пути индексации, **Then** оба пути соблюдают лимиты по одинаковым правилам.
2. **Given** лимиты не заданы, **When** выполняется запуск индексации, **Then** результат соответствует прежнему поведению без дополнительных ограничений.

---

### User Story 3 - Прозрачная отчетность по ограничениям (Priority: P3)

Оператор получает в итоговой сводке объяснение примененных лимитов и причин пропуска файлов, чтобы быстро понять, почему часть файлов не была обработана.

**Why this priority**: Прозрачная диагностика снижает время анализа и риск неверных операционных решений.

**Independent Test**: Выполнить запуск, который упирается в лимиты, и проверить, что сводка содержит значения лимитов и причины пропуска.

**Acceptance Scenarios**:

1. **Given** запуск достиг лимита глубины или количества файлов, **When** оператор просматривает сводку запуска, **Then** он видит примененные лимиты и причины пропусков по каждому типу ограничения.
2. **Given** запуск не достиг лимитов, **When** оператор просматривает сводку, **Then** он видит, что ограничения были применены, но пропусков по этим причинам не возникло.

---

### Edge Cases

- Лимит глубины равен нулю: обрабатываются только файлы на верхнем уровне рабочей директории.
- Лимит количества файлов меньше числа подходящих файлов уже на раннем этапе обхода.
- Одновременно достигаются оба лимита в одном запуске.
- Переданы некорректные значения лимитов (отрицательные или нечисловые).
- Состав файлов не менялся, но запуск повторяется с теми же лимитами.

## Assumptions

- Лимиты являются опциональными и по умолчанию не ограничивают текущее поведение (backward compatibility).
- Глубина считается относительно корня рабочей директории запуска.
- Лимит количества файлов применяется к файлам, которые уже прошли стандартные правила отбора запуска.
- При неизменном наборе входных данных и одинаковых лимитах набор выбранных файлов должен быть одинаковым.

## Scope

### In Scope

- Добавление лимита глубины обхода для запуска индексации.
- Добавление лимита количества файлов для запуска индексации.
- Применение лимитов в полном режиме и релевантных ingestion-путях.
- Отражение примененных лимитов и причин пропуска файлов в сводке запуска.

### Out of Scope

- Изменение логики отбора поддерживаемых типов файлов.
- Изменение правил разбиения файлов на чанки и семантики поиска.
- Переработка формата сводок, не связанная с новыми лимитами.

## Dependencies

- Существующий процесс формирования сводки запуска индексации.
- Существующий механизм конфигурации параметров запуска.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST позволять задавать максимальную глубину обхода файлов для запуска индексации.
- **FR-002**: Система MUST позволять задавать максимальное количество файлов для одного запуска индексации.
- **FR-003**: Система MUST применять оба лимита в полном режиме индексации.
- **FR-004**: Система MUST применять оба лимита во всех релевантных ingestion-путях, где выполняется обход файлов.
- **FR-005**: Система MUST применять лимиты детерминированно при одинаковых входных данных и одинаковых параметрах запуска.
- **FR-006**: Система MUST исключать из обработки файлы, которые выходят за заданную глубину обхода.
- **FR-007**: Система MUST прекращать отбор новых файлов после достижения лимита количества файлов.
- **FR-008**: Система MUST включать в итоговую сводку фактически примененные значения лимитов для конкретного запуска.
- **FR-009**: Система MUST включать в итоговую сводку причины пропуска файлов из-за лимита глубины и из-за лимита количества файлов.
- **FR-010**: Система MUST сохранять прежнее поведение запусков, если лимиты не заданы.
- **FR-011**: Система MUST отклонять запуск с некорректными значениями лимитов и сообщать причину отклонения.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Поведение ограничений должно быть операционно предсказуемым: одинаковый вход всегда дает одинаковый результат отбора файлов.
- **NFR-002**: Сводка запуска должна быть понятной для оператора без необходимости анализа сырых логов.
- **NFR-003**: Введение лимитов не должно ухудшать обратную совместимость сценариев, где ограничения не используются.

### Key Entities *(include if feature involves data)*

- **IndexingRunLimitPolicy**: набор ограничений запуска (максимальная глубина, максимальное количество файлов, факт их применения).
- **FileSelectionDecision**: решение по каждому кандидату на обработку (выбран/пропущен, причина пропуска, глубина файла).
- **IndexingRunLimitSummary**: агрегированная сводка запуска по лимитам (примененные значения, счетчики пропусков по причинам).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В 100% запусков, где заданы лимиты, сводка запуска показывает фактически примененные значения ограничений.
- **SC-002**: Для одинакового набора файлов и одинаковых лимитов два повторных запуска выбирают идентичный набор файлов для обработки.
- **SC-003**: В 100% запусков с превышением лимитов сводка явно разделяет пропуски по причине лимита глубины и по причине лимита количества файлов.
- **SC-004**: При отключенных лимитах количество обработанных и пропущенных файлов по причинам лимитов остается равным нулю.
- **SC-005**: При заданном лимите количества файлов число фактически обработанных файлов в запуске никогда не превышает этот лимит.
