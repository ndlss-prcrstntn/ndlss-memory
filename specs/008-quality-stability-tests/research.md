# Research: Качество и стабильность

## Decision 1: Единый quality-run как последовательность четырех слоев (unit -> integration -> contract -> e2e)

- Decision: Выполнять проверки в фиксированном порядке: сначала unit, затем integration, затем contract, затем E2E smoke.
- Rationale: Такой порядок быстрее локализует дефекты и сокращает стоимость диагностики; тяжелые проверки запускаются только после прохождения базовой логики.
- Alternatives considered: 1) Запускать все параллельно. Отклонено из-за шумных зависимых падений. 2) Запускать только E2E. Отклонено из-за низкой диагностируемости.

## Decision 2: Идемпотентность подтверждать через повторный прогон с одинаковым fixture-набором

- Decision: Проверка идемпотентности строится как два последовательных запуска без изменения входных данных с контролем отсутствия прироста дублей.
- Rationale: Это напрямую проверяет бизнес-требование стабильной повторной индексации.
- Alternatives considered: 1) Проверять только внутренние счетчики в памяти. Отклонено, т.к. не покрывает persisted state. 2) Проверять только hash-функции unit-тестом. Отклонено как недостаточно.

## Decision 3: Интеграционные проверки привязать к публичным endpoint-ам `mcp-server`

- Decision: Для integration/E2E использовать только публичные HTTP endpoint-ы (`/health`, `/v1/indexing/*`, `/v1/search/*`).
- Rationale: Это валидирует реальный пользовательский путь и совместимость между сервисами.
- Alternatives considered: 1) Вызывать внутренние функции напрямую. Отклонено, т.к. скрывает проблемы оркестрации. 2) Проверять только логи контейнеров. Отклонено как недетерминированно.

## Decision 4: Контрактные проверки MCP-инструментов хранить в markdown + OpenAPI

- Decision: Сохранить существующий подход markdown contract checks в `tests/contract/` и дополнить/синхронизировать OpenAPI-спецификацию поверхности API, участвующей в quality-run.
- Rationale: Markdown удобен для ревью, OpenAPI дает строгую машинную спецификацию.
- Alternatives considered: 1) Только markdown. Отклонено из-за меньшей формальности. 2) Только OpenAPI. Отклонено, т.к. теряется удобство сценарного ревью.

## Decision 5: Диагностику формировать через единый stage-result формат

- Decision: Каждому этапу прогона присваивать структурированный результат (status, duration, failures, artifacts).
- Rationale: Упрощает triage и соответствует требованию однозначного PASS/FAIL и причины сбоя.
- Alternatives considered: 1) Свободный текст в логах. Отклонено из-за плохой машиночитаемости.

## Decision 6: `README.md` и quickstart обновлять в том же изменении

- Decision: Любое изменение состава quality-checks сопровождается обновлением пользовательской документации в этом же наборе изменений.
- Rationale: Это прямое требование конституции и снижает расхождение между кодом и документацией.
- Alternatives considered: 1) Отложенное обновление документации. Отклонено как нарушение delivery gates.

## Clarification Resolution

Дополнительных уточнений не требуется: технический контекст и критерии исполнения определены на базе текущей архитектуры репозитория и конституции.
