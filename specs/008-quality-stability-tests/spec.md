# Спецификация фичи: Качество и стабильность

**Feature Branch**: `008-quality-stability-tests`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "Качество и стабильность: unit-тесты (чанкинг, хеширование, фильтрация), integration-тесты (запись в Qdrant, поиск через MCP), contract-тесты MCP-инструментов, E2E (docker compose up, full-scan, delta-after-commit, проверка поискового запроса), проверка идемпотентности повторного запуска"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Базовое покрытие критичной логики (Priority: P1)

Как владелец проекта, я хочу иметь автоматические проверки ключевой логики индексации, чтобы изменения не ломали базовую обработку файлов и контроль дубликатов.

**Why this priority**: Это минимальный барьер качества для безопасных изменений в ядре системы.

**Independent Test**: Запустить набор базовых проверок логики обработки файлов и убедиться, что все тесты проходят на стабильной сборке.

**Acceptance Scenarios**:

1. **Given** есть эталонный набор входных данных, **When** выполняются проверки базовой логики, **Then** система корректно обрабатывает чанкинг, хеширование и фильтрацию.
2. **Given** повторный запуск без изменений во входных данных, **When** выполняется проверка идемпотентности, **Then** система не создает дублирующие результаты.

---

### User Story 2 - Проверка межсервисных сценариев (Priority: P2)

Как оператор стека, я хочу проверять взаимодействие сервисов в реальных сценариях, чтобы заранее выявлять проблемы интеграции хранилища и поисковых инструментов.

**Why this priority**: Межсервисные сбои критичны для рабочей эксплуатации и часто не выявляются локальными проверками.

**Independent Test**: Выполнить интеграционный сценарий с записью данных в хранилище и последующим поисковым запросом; проверить корректный результат без ручной донастройки.

**Acceptance Scenarios**:

1. **Given** стек сервисов запущен, **When** выполняется интеграционный сценарий записи данных, **Then** данные становятся доступны для последующих запросов.
2. **Given** данные присутствуют в индексе, **When** выполняется поисковый запрос через MCP-инструмент, **Then** возвращается предсказуемый структурированный ответ.

---

### User Story 3 - Сквозная регрессия перед релизом (Priority: P3)

Как релиз-инженер, я хочу запускать единый сквозной сценарий качества, чтобы подтверждать стабильность полного цикла работы системы перед публикацией изменений.

**Why this priority**: Сквозная проверка снижает риск регрессий в релизе, затрагивающих несколько подсистем одновременно.

**Independent Test**: Выполнить полный сценарий от запуска стека до поискового запроса и повторного запуска с проверкой идемпотентности; убедиться, что сценарий завершается успешно.

**Acceptance Scenarios**:

1. **Given** чистое окружение запуска, **When** выполняется сквозной сценарий качества, **Then** система успешно проходит этапы запуска, индексации, delta-обновления и поиска.
2. **Given** тот же набор данных после первого прохода, **When** сквозной сценарий запускается повторно, **Then** результаты остаются согласованными без роста дубликатов.

---

### Edge Cases

- Пустой или почти пустой набор данных для индексации.
- Отсутствие совпадений в поисковом запросе во время интеграционного прогона.
- Частичный отказ одного из сервисов во время сквозной проверки.
- Слишком длительная обработка на одном из этапов сквозного сценария.
- Повторный запуск после частично завершившегося прогона.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST предоставлять автоматические проверки базовой логики обработки данных, включая разбивку контента, вычисление хеша и фильтрацию входных файлов.
- **FR-002**: Система MUST предоставлять автоматическую проверку идемпотентности повторного запуска на неизмененном наборе данных.
- **FR-003**: Система MUST предоставлять интеграционную проверку записи данных в векторное хранилище.
- **FR-004**: Система MUST предоставлять интеграционную проверку поиска через MCP-инструменты на подготовленном наборе данных.
- **FR-005**: Система MUST предоставлять контрактные проверки MCP-инструментов с валидацией структуры ответов и ошибок.
- **FR-006**: Система MUST предоставлять сквозной сценарий качества, который покрывает запуск стека, индексацию, обновление после изменений и поисковый запрос.
- **FR-007**: Система MUST формировать однозначный результат прогона качества (успех/неуспех) с указанием проваленных этапов.
- **FR-008**: Система MUST обновлять пользовательскую документацию при изменении требований или состава проверок качества.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Полный набор проверок качества должен быть воспроизводим на чистом окружении без ручных правок сценариев.
- **NFR-002**: Для каждого прогона качества должен сохраняться диагностируемый отчет по этапам и статусам.
- **NFR-003**: Проверки качества должны быть устойчивыми к повторному запуску и давать согласованный результат при неизменных входных данных.

### Assumptions

- Тестовые данные и сценарии поддерживаются в актуальном состоянии вместе с изменениями функциональности.
- Команда разработки использует общий стандарт прохождения проверок перед слиянием изменений.
- Временные лимиты прогонов определяются для эталонного окружения и пересматриваются при росте объема данных.

### Key Entities *(include if feature involves data)*

- **QualityRun**: единичный прогон проверки качества с идентификатором, временем запуска, итоговым статусом и списком этапов.
- **QualityStageResult**: результат отдельного этапа (базовая логика, интеграция, контракт, сквозной сценарий) с длительностью и ошибками.
- **RegressionEvidence**: набор артефактов прогона (логи, статусы, диагностические сообщения), используемый для анализа сбоев.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% регулярных прогонов базовых проверок завершаются успешно без ручного вмешательства.
- **SC-002**: Не менее 95% интеграционных прогонов завершаются успешно на эталонном окружении.
- **SC-003**: Не менее 90% сквозных прогонов завершаются полностью в пределах целевого времени прогона, установленного командой.
- **SC-004**: Для 100% неуспешных прогонов доступен отчет с указанием этапа и причины сбоя.
- **SC-005**: Повторный прогон на неизменных входных данных сохраняет стабильный результат без роста дубликатов в 100% проверяемых случаев.

