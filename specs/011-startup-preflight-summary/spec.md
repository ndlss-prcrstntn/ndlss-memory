# Спецификация фичи: Предполетные проверки старта и сводка готовности

**Feature Branch**: `011-startup-preflight-summary`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "Add startup preflight checks and ready summary for ndlss-memory ... Только на русском"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Проверка готовности окружения до старта (Priority: P1)

Как оператор, я хочу до запуска рабочих процессов сразу видеть, что критичные зависимости доступны и рабочая директория корректна, чтобы стек не переходил в «полуживое» состояние с неочевидными ошибками.

**Why this priority**: Без ранней проверки зависимостей последующие сбои происходят позже, диагностируются дольше и блокируют использование системы.

**Independent Test**: Запустить сервис в среде с недоступным Qdrant или невалидным workspace и убедиться, что старт завершается сразу с явной машиночитаемой ошибкой и подсказкой по исправлению.

**Acceptance Scenarios**:

1. **Given** Qdrant недоступен, **When** выполняется запуск сервиса, **Then** сервис останавливает старт до перехода в рабочий режим и возвращает структурированную ошибку с причиной недоступности.
2. **Given** путь workspace отсутствует или недоступен для чтения, **When** выполняется запуск сервиса, **Then** сервис завершает запуск с явной ошибкой валидации пути и не сообщает состояние готовности.
3. **Given** выбран режим, требующий git-проверок, **When** git недоступен, **Then** сервис завершает запуск с понятной диагностикой и рекомендацией по исправлению.

---

### User Story 2 - Единая сводка готовности после успешного старта (Priority: P2)

Как оператор, я хочу сразу после старта видеть единый краткий статус «готово», чтобы быстро понимать текущее состояние стека без чтения разрозненных логов.

**Why this priority**: Даже при успешном старте требуется быстрый операционный контроль и минимальное время до первой полезной проверки.

**Independent Test**: Выполнить запуск в валидной среде и убедиться, что в логах появляется единый блок готовности с ключевыми параметрами и без неоднозначных формулировок.

**Acceptance Scenarios**:

1. **Given** все зависимости доступны, **When** сервис завершает старт, **Then** в логе появляется единый статус готовности с состоянием сервисов, путем workspace, активным режимом индексации, MCP endpoint и именем коллекции.
2. **Given** успешный старт, **When** оператор читает лог запуска, **Then** он может определить готовность системы к работе без дополнительных ручных запросов.

---

### User Story 3 - Обратная совместимость существующих сценариев запуска (Priority: P3)

Как владелец решения, я хочу внедрить предполетные проверки без изменения текущего пользовательского контракта, чтобы существующие compose preset-сценарии продолжали работать.

**Why this priority**: Изменение поведения старта не должно ломать уже работающие окружения и пользовательские инструкции.

**Independent Test**: Прогнать стандартный сценарий запуска через актуальные preset-файлы и убедиться, что успешные кейсы остаются успешными, а внешнее поведение API после старта не меняется.

**Acceptance Scenarios**:

1. **Given** корректное существующее окружение, **When** выполняется запуск по текущим preset-файлам, **Then** система стартует успешно и публичное поведение после старта остается прежним.
2. **Given** обновление только startup-валидации, **When** выполняются базовые пользовательские проверки после старта, **Then** результаты соответствуют предыдущему контракту поведения.

---

### Edge Cases

- Qdrant отвечает, но с некорректным статусом доступности (частичная деградация).
- Workspace существует, но содержит только недоступные для чтения вложенные элементы.
- Режим индексации переключается на git-зависимый, но репозиторий отсутствует в указанном пути.
- Во время старта часть сервисов готова, часть — нет; сводка не должна сообщать ложную готовность.
- Повторный запуск после временного сбоя должен выдавать актуальный статус, а не кэшированный результат прошлой проверки.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST выполнять предполетную проверку доступности Qdrant до перехода в рабочее состояние.
- **FR-002**: Система MUST выполнять предполетную проверку существования и читаемости рабочей директории до перехода в рабочее состояние.
- **FR-003**: Система MUST выполнять предполетную проверку доступности git, если активный режим запуска зависит от git-проверок.
- **FR-004**: При любой неуспешной предполетной проверке система MUST завершать старт в fail-fast режиме с машиночитаемой структурой ошибки и человекочитаемым пояснением.
- **FR-005**: При успешном прохождении предполетных проверок система MUST публиковать единую сводку готовности, включающую: состояние сервисов, путь workspace, активный режим индексации, MCP endpoint и имя коллекции.
- **FR-006**: Система MUST сохранять обратную совместимость существующих сценариев запуска через актуальные compose preset-файлы.
- **FR-007**: Публичное поведение системы после успешного старта MUST оставаться неизменным относительно текущего рабочего контракта.
- **FR-008**: Документация по запуску MUST отражать новую модель диагностики старта и интерпретации статуса готовности.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Результат предполетной проверки MUST быть детерминированным и однозначным для одинакового входного состояния окружения.
- **NFR-002**: Диагностика стартовых ошибок MUST быть пригодной для автоматического разбора (машиночитаемые коды/категории ошибок).
- **NFR-003**: В успешном сценарии оператор MUST получать сводку готовности в течение одного стандартного цикла старта без дополнительных действий.
- **NFR-004**: Добавление предполетной проверки MUST не ухудшать наблюдаемость существующих логов и не удалять текущие информативные сообщения.

### Key Entities *(include if feature involves data)*

- **StartupCheckResult**: результат одной предполетной проверки (тип проверки, статус, код ошибки, сообщение, детали).
- **StartupReadinessSummary**: агрегированная сводка состояния после старта (готовность сервисов, workspace, режим индексации, endpoint, коллекция).
- **StartupFailureReport**: структурированный отчет о неуспешном старте с корневой причиной и рекомендацией по исправлению.

### Assumptions

- Под «критичными зависимостями» в рамках этой фичи понимаются Qdrant, workspace и git (только для git-зависимых режимов).
- Существующие compose preset-файлы считаются основным и поддерживаемым способом запуска для пользователей.
- Успешный старт определяется переходом системы в рабочее состояние без нарушения текущего публичного контракта после запуска.

### Dependencies

- Актуальные compose preset-конфигурации и переменные окружения для режимов запуска.
- Доступность диагностического канала логирования, через который оператор читает статус старта.
- Наличие машиночитаемого формата ошибок, совместимого с текущим операционным мониторингом.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В 100% негативных сценариев предполетной проверки система завершает старт до рабочего режима и предоставляет явный код причины сбоя.
- **SC-002**: В 95% успешных запусков оператор может определить итоговую готовность системы менее чем за 60 секунд по единой сводке старта.
- **SC-003**: В 100% проверенных сценариев запуска через поддерживаемые preset-файлы не возникает регрессии публичного поведения после старта.
- **SC-004**: Доля стартовых инцидентов с неочевидной причиной снижается минимум на 50% по сравнению с базовой диагностикой до внедрения фичи.
