# Спецификация фичи: Bootstrap первого запуска индексации

**Feature Branch**: `012-bootstrap-first-run-indexing`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "Implement first-run bootstrap for zero-friction indexing..."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Поиск готов после первого старта (Priority: P1)

Как оператор, я запускаю стек в новой рабочей директории и получаю пригодный к поиску индекс без ручного вызова запуска индексации.

**Why this priority**: Это основной DX-сценарий. Без него продукт требует ручных шагов и теряет ценность zero-friction.

**Independent Test**: На «чистой» директории после `docker compose up` выполняется поиск по известной строке без ручного запуска ingestion.

**Acceptance Scenarios**:

1. **Given** новая рабочая директория и отсутствует поисковая коллекция, **When** оператор впервые запускает стек, **Then** коллекция создается автоматически и стартует первичная индексация.
2. **Given** первичная индексация завершилась успешно, **When** оператор выполняет поисковый запрос, **Then** система возвращает релевантные результаты без дополнительных ручных действий.

---

### User Story 2 - Идемпотентный перезапуск (Priority: P2)

Как оператор, я перезапускаю сервисы без изменений в проекте и не получаю повторный дорогостоящий bootstrap.

**Why this priority**: Повторный bootstrap увеличивает время старта и нагрузку, что ухудшает эксплуатацию.

**Independent Test**: Три последовательных рестарта без изменений в файлах не запускают повторный полный bootstrap и не создают дубли в индексе.

**Acceptance Scenarios**:

1. **Given** bootstrap уже выполнен для рабочей директории, **When** оператор перезапускает стек, **Then** система пропускает первичную индексацию и сохраняет существующее состояние.
2. **Given** состояние bootstrap уже отмечено как завершенное, **When** сервис стартует снова, **Then** в логах явно отражается пропуск повторного bootstrap по причине already-initialized.

---

### User Story 3 - Прозрачный статус bootstrap (Priority: P3)

Как оператор, я вижу явный статус готовности и причины ошибок bootstrap в логах и статусных эндпоинтах.

**Why this priority**: Наблюдаемость снижает время диагностики и повышает предсказуемость эксплуатации.

**Independent Test**: При успешном и при неуспешном bootstrap оператор получает однозначный статус, причину и текущее состояние через логи и summary-endpoint.

**Acceptance Scenarios**:

1. **Given** bootstrap выполняется или завершен, **When** оператор смотрит логи старта и summary-статус, **Then** отображаются состояние bootstrap, режим индексации, целевая коллекция и итог готовности.
2. **Given** bootstrap не может выполниться из-за недоступности зависимости, **When** оператор запрашивает статус, **Then** получает структурированную ошибку с actionable-описанием.

---

### Edge Cases

- Рабочая директория существует, но не содержит поддерживаемых файлов.
- Коллекция уже существует, но пуста (частично завершенный предыдущий запуск).
- Стек перезапускается во время выполняющегося bootstrap.
- Зависимость индекса недоступна на старте, затем восстанавливается.
- Ручной запуск ingestion инициирован оператором во время авто-bootstrap.

### Assumptions

- Каждая рабочая директория имеет стабильный идентификатор, пригодный для определения «первого запуска».
- Автоматический bootstrap не отключает и не заменяет существующие ручные сценарии запуска индексации.
- Итоговая «готовность к поиску» определяется фактом наличия коллекции и ненулевого числа проиндексированных точек для непустого workspace.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST автоматически определять первый запуск для конкретной рабочей директории.
- **FR-002**: Система MUST автоматически создавать поисковую коллекцию при первом запуске, если она отсутствует.
- **FR-003**: Система MUST автоматически запускать первичную индексацию при первом запуске без ручного API-триггера.
- **FR-004**: Система MUST выполнять первичный bootstrap идемпотентно и не повторять дорогостоящий полный bootstrap на каждом рестарте.
- **FR-005**: Система MUST сохранять доступность существующих ручных endpoint-ов запуска и мониторинга индексации без изменения их контракта.
- **FR-006**: Система MUST публиковать статус bootstrap в логах и в summary-статусах индексации с указанием текущего состояния и причины.
- **FR-007**: Система MUST возвращать структурированные fail-fast ошибки при невозможности выполнить критические стартовые проверки bootstrap.
- **FR-008**: Система MUST позволять оператору явно проверить наличие коллекции и текущий объем проиндексированных данных после старта.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: На «чистой» рабочей директории система должна переходить в состояние пригодности к поиску не более чем за 10 минут для типового проекта малого/среднего размера.
- **NFR-002**: Перезапуск без изменений во входных файлах не должен приводить к росту количества точек в индексе из-за дубликатов.
- **NFR-003**: Существующее поведение публичных API и ручных сценариев индексации должно оставаться обратно совместимым.
- **NFR-004**: Статус bootstrap должен быть однозначно интерпретируем оператором без анализа внутренних деталей реализации.

### Key Entities *(include if feature involves data)*

- **WorkspaceBootstrapState**: идентификатор рабочей директории, признак first-run, текущий статус bootstrap, время старта/завершения, причина последнего отказа.
- **CollectionReadinessState**: имя коллекции, признак существования, число точек, время последней проверки.
- **IndexingBootstrapSummary**: тип запуска (auto/manual), статус, счетчики обработанных/ошибочных элементов, итог готовности к поиску.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В новом workspace первый запуск стека приводит к успешному поисковому ответу без ручного запуска ingestion в 100% проверок smoke-сценария.
- **SC-002**: После первого успешного bootstrap три последовательных рестарта без изменений не инициируют повторный полный bootstrap.
- **SC-003**: После старта оператор получает единый читаемый ready-summary со статусом сервиса, workspace path, режимом индексации и именем коллекции в 100% запусков.
- **SC-004**: При сбое зависимостей оператор получает fail-fast диагностическое сообщение с причиной и шагом восстановления не позднее чем через 60 секунд после старта.

