# Спецификация фичи: Режим Full Scan

**Feature Branch**: `002-full-scan`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "3. Режим Full Scan: реализовать полный обход папки, фильтрацию по поддерживаемым типам, исключение файлов по паттернам, логирование прогресса индексации, обработку ошибок чтения файлов, защиту от слишком больших файлов."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Полная индексация директории (Priority: P1)

Как пользователь, я запускаю Full Scan и получаю индекс всех подходящих файлов
из выбранной директории без ручного перечисления путей.

**Why this priority**: Это базовая ценность режима Full Scan и основа для поиска.

**Independent Test**: Запустить Full Scan на тестовой директории с файлами
разных типов и проверить, что в индекс попали только поддерживаемые файлы.

**Acceptance Scenarios**:

1. **Given** указана директория индексации и список поддерживаемых типов,
   **When** пользователь запускает Full Scan, **Then** система проходит всю
   директорию рекурсивно и индексирует все подходящие файлы.
2. **Given** в директории есть вложенные папки, **When** выполняется Full Scan,
   **Then** файлы из вложенных папок также учитываются по тем же правилам.

---

### User Story 2 - Управляемая фильтрация файлов (Priority: P2)

Как пользователь, я задаю правила исключений и получаю предсказуемый состав
файлов в индексе без мусора.

**Why this priority**: Без фильтрации индекс быстро засоряется нерелевантными
или служебными файлами.

**Independent Test**: Настроить include/exclude правила, запустить Full Scan и
сверить результат с ожидаемым списком файлов.

**Acceptance Scenarios**:

1. **Given** задан список исключаемых паттернов, **When** запускается Full Scan,
   **Then** файлы и директории по этим паттернам пропускаются до чтения.
2. **Given** в директории есть неподдерживаемые типы файлов, **When** выполняется
   Full Scan, **Then** они не попадают в индекс и фиксируются как пропущенные.

---

### User Story 3 - Прозрачный прогресс и устойчивость (Priority: P3)

Как пользователь, я вижу ход индексации и понимаю, почему отдельные файлы
пропущены, без остановки всего процесса.

**Why this priority**: Диагностика и устойчивость сокращают время настройки и
эксплуатации.

**Independent Test**: Добавить в набор поврежденные/недоступные/слишком большие
файлы и убедиться, что Full Scan завершился и вывел причины пропуска.

**Acceptance Scenarios**:

1. **Given** часть файлов недоступна для чтения, **When** выполняется Full Scan,
   **Then** процесс продолжается, а проблемы фиксируются в журнале и отчете.
2. **Given** встречаются файлы больше допустимого размера, **When** выполняется
   Full Scan, **Then** такие файлы пропускаются с явной причиной.

---

### Edge Cases

- Пустая директория индексации.
- Директория содержит только исключенные паттернами или неподдерживаемые файлы.
- Смешанный регистр расширений (`.MD`, `.Md`, `.md`).
- Файлы без расширения.
- Сбой чтения отдельного файла во время сканирования.
- Файлы, превышающие лимит размера.
- Изменение содержимого файла в момент сканирования.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать запуск режима Full Scan для заданной
  директории индексации.
- **FR-002**: Full Scan MUST выполнять рекурсивный обход всей директории
  индексации, включая вложенные папки.
- **FR-003**: Система MUST включать в обработку только файлы с поддерживаемыми
  типами из конфигурации.
- **FR-004**: Система MUST исключать файлы и директории, совпадающие с
  настроенными паттернами исключения.
- **FR-005**: Проверка расширений файла MUST быть нечувствительной к регистру.
- **FR-006**: При ошибке чтения отдельного файла система MUST пропустить этот
  файл, зафиксировать причину и продолжить Full Scan.
- **FR-007**: Система MUST применять лимит максимального размера файла и
  пропускать файлы, превышающие лимит, с явной причиной.
- **FR-008**: Система MUST публиковать прогресс Full Scan с минимумом:
  количество обработанных файлов, количество проиндексированных файлов,
  количество пропущенных файлов, количество ошибок.
- **FR-009**: По завершении Full Scan система MUST выдавать итоговый отчет с
  суммарной статистикой и временем выполнения.
- **FR-010**: Если подходящих файлов не найдено, Full Scan MUST завершаться
  успешно с нулевым результатом и понятным статусом.
- **FR-011**: Правила типов файлов, исключений, пути индексации и лимита размера
  MUST настраиваться через конфигурацию запуска без изменения исходного кода.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: На эталонном проекте размером до 10 000 файлов Full Scan должен
  завершаться не более чем за 15 минут.
- **NFR-002**: Прогресс Full Scan должен обновляться не реже одного раза в
  60 секунд, пока задача выполняется.
- **NFR-003**: Для 100% пропущенных файлов в итоговом отчете должна быть указана
  категория причины пропуска.
- **NFR-004**: Полный запуск Full Scan не должен прерываться из-за ошибки чтения
  одного файла.

### Assumptions

- Директория индексации доступна для чтения во время выполнения задачи.
- Типы поддерживаемых файлов определяются расширениями.
- Пользователь заранее задает лимит размера файла в конфигурации запуска.
- Дальнейшая обработка содержимого (например, чанкинг и эмбеддинги) находится
  вне scope этой фичи.

### Key Entities *(include if feature involves data)*

- **ScanJob**: запуск Full Scan с параметрами, временем старта/окончания и
  итоговым статусом.
- **FileCandidate**: обнаруженный файл с атрибутами пути, типа, размера и
  решением (индексировать/пропустить).
- **SkipReason**: классификация причины пропуска файла (неподдерживаемый тип,
  исключающий паттерн, лимит размера, ошибка чтения).
- **ScanSummary**: агрегированная статистика завершенного Full Scan (обработано,
  проиндексировано, пропущено, ошибки, длительность).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% файлов с поддерживаемыми типами из тестового набора попадают
  в обработку Full Scan.
- **SC-002**: 100% файлов, попадающих под исключающие паттерны, не включаются в
  индекс и отражаются как пропущенные.
- **SC-003**: Не менее 95% запусков Full Scan завершаются успешно на типовом
  репозитории без ручного вмешательства.
- **SC-004**: Пользователь может определить текущее состояние Full Scan по логу
  не позднее чем через 60 секунд после старта задачи.
- **SC-005**: Для 100% файлов, не попавших в индекс, пользователь видит причину
  пропуска в итоговом отчете.

