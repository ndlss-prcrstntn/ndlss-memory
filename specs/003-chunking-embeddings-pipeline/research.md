# Research: Пайплайн чанкинга и эмбеддингов

## Контекст

Фича: `003-chunking-embeddings-pipeline`
Цель: обеспечить стабильный ingestion-флоу для chunk -> embedding -> upsert c
обязательными метаданными и повторяемым поведением при ретраях.

## Решения

### Decision: Фиксировать детерминированный порядок чанков внутри файла
- Rationale: упрощает трассировку, сравнение повторных запусков и обновление
  записей по стабильному идентификатору.
- Alternatives considered:
  - Параллельная генерация чанков без гарантии порядка: отклонено как сложнее
    для идемпотентности и диагностики.

### Decision: Параметры chunk_size и overlap валидируются до старта job
- Rationale: предотвращает запуск с невалидными параметрами и ранний отказ в
  середине обработки.
- Alternatives considered:
  - Игнорировать невалидные параметры и брать defaults: отклонено как неявное
    поведение, ухудшающее предсказуемость.

### Decision: Retry эмбеддингов выполнять только для транзиентных ошибок
- Rationale: снижает бессмысленные повторы для фатальных ошибок и экономит
  ресурсы.
- Alternatives considered:
  - Retry для всех ошибок: отклонено как избыточная нагрузка и рост времени.
  - Без retry: отклонено как низкая устойчивость в реальной сети.

### Decision: Upsert векторных записей по детерминированному ключу чанка
- Rationale: обеспечивает обновляемость без дубликатов при повторной обработке.
- Alternatives considered:
  - Всегда создавать новые записи: отклонено, нарушает идемпотентность.

### Decision: Обязательные метаданные включают путь, имя, тип, content hash, timestamp
- Rationale: покрывает требования трассируемости и проверку изменений данных.
- Alternatives considered:
  - Минимальные метаданные только с путём: отклонено как недостаточно для
    контроля версий и отладки.

### Decision: Контракт управления ingestion оформляется отдельным OpenAPI для фичи
- Rationale: сохраняет явную границу API и упрощает contract tests.
- Alternatives considered:
  - Расширять только существующий observability-контракт: отклонено, смешивает
    разные группы endpoint'ов.

## Исследовательские задачи и закрытие неопределенностей

- Task: "Find best practices for chunk overlap strategies" -> выбран
  детерминированный порядок и строгая валидация overlap.
- Task: "Find retry patterns for embedding generation" -> выбран retry только
  для транзиентных ошибок с лимитом попыток.
- Task: "Find idempotent upsert patterns for vector stores" -> выбран
  детерминированный ключ чанка для upsert.
- Task: "Find metadata baseline for vectorized document chunks" -> закреплен
  обязательный набор метаданных.

`NEEDS CLARIFICATION` в `plan.md` отсутствуют.
