# Спецификация фичи: Пайплайн чанкинга и эмбеддингов

**Feature Branch**: `003-chunking-embeddings-pipeline`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "Пайплайн чанкинга и эмбеддингов: реализовать разбивку файлов на чанки, настроить размер чанка и overlap, интегрировать генерацию эмбеддингов, добавить retry-механику для эмбеддингов, запись в Qdrant (upsert), сохранение метаданных: путь, имя файла, тип файла, hash контента, timestamp"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Управляемый чанкинг документов (Priority: P1)

Как пользователь, я хочу, чтобы каждый файл автоматически разбивался на чанки с
настраиваемыми параметрами размера и overlap, чтобы подготовить данные для
дальнейшего поиска.

**Why this priority**: Без корректного чанкинга невозможно стабильно строить
эмбеддинги и индексировать контент.

**Independent Test**: Запустить обработку набора файлов и проверить, что для
каждого поддерживаемого файла создаются чанки в соответствии с заданными
параметрами размера и overlap.

**Acceptance Scenarios**:

1. **Given** задан набор поддерживаемых файлов и параметры чанкинга,
   **When** запускается обработка, **Then** система формирует последовательность
   чанков без пропусков текста внутри файла.
2. **Given** задан overlap больше нуля, **When** создаются соседние чанки,
   **Then** соседние чанки имеют пересечение на ожидаемом количестве символов.

---

### User Story 2 - Надежная генерация эмбеддингов и upsert (Priority: P2)

Как пользователь, я хочу, чтобы для каждого чанка генерировался эмбеддинг с
повторными попытками при временных сбоях и чтобы результат надежно сохранялся в
векторном индексе.

**Why this priority**: Даже при качественном чанкинге фича не дает ценности,
если эмбеддинги не создаются или теряются при временных ошибках.

**Independent Test**: Смоделировать временную ошибку генерации эмбеддинга и
проверить, что повторные попытки приводят к успешному сохранению данных без
дубликатов одной и той же записи.

**Acceptance Scenarios**:

1. **Given** сервис эмбеддингов временно недоступен, **When** система получает
   транзиентную ошибку, **Then** выполняются повторные попытки до лимита и
   финальный результат фиксируется как успех или контролируемый отказ.
2. **Given** эмбеддинг успешно получен, **When** выполняется запись в индекс,
   **Then** чанк записывается через upsert и может быть обновлен при повторной
   обработке.

---

### User Story 3 - Трассируемые метаданные чанков (Priority: P3)

Как пользователь, я хочу видеть для каждой записи источники и технические
метаданные (путь, имя, тип, hash, timestamp), чтобы проверять происхождение
контента и анализировать изменения.

**Why this priority**: Метаданные нужны для диагностики, фильтрации и
последующей идемпотентной обработки.

**Independent Test**: После обработки файла получить записи из индекса и
проверить наличие полного набора обязательных метаданных для каждого чанка.

**Acceptance Scenarios**:

1. **Given** файл успешно обработан, **When** запись чанка сохраняется,
   **Then** в записи присутствуют все обязательные метаданные источника.
2. **Given** содержимое файла изменилось, **When** файл обрабатывается повторно,
   **Then** hash и timestamp отражают актуальную версию данных.

---

### Edge Cases

- Файл меньше размера одного чанка.
- Файл пустой или содержит только пробелы.
- Значение overlap равно 0.
- Значение overlap равно или больше размера чанка.
- Генерация эмбеддинга падает на всех retry попытках.
- Повторная запись того же чанка выполняется после изменения файла.
- В одном запуске обрабатываются файлы разных типов и размеров.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST разбивать каждый поддерживаемый файл на чанки в
  соответствии с настраиваемыми параметрами размера чанка и overlap.
- **FR-002**: Система MUST гарантировать сохранение порядка чанков внутри одного
  файла.
- **FR-003**: Система MUST валидировать параметры чанкинга до запуска обработки.
- **FR-004**: Для каждого чанка система MUST запускать генерацию эмбеддинга.
- **FR-005**: При временных ошибках генерации эмбеддинга система MUST выполнять
  повторные попытки до заданного лимита.
- **FR-006**: При исчерпании retry попыток система MUST помечать чанк как
  ошибочный с машиночитаемой причиной.
- **FR-007**: Система MUST сохранять чанки и эмбеддинги через upsert, чтобы
  повторная обработка могла обновлять записи.
- **FR-008**: Каждая сохраненная запись чанка MUST содержать метаданные:
  путь файла, имя файла, тип файла, hash контента, timestamp обработки.
- **FR-009**: Система MUST поддерживать повторную обработку измененного файла с
  обновлением связанных метаданных.
- **FR-010**: Система MUST предоставлять агрегированную статистику запуска:
  количество созданных чанков, успешных эмбеддингов, ошибок и повторных попыток.
- **FR-011**: Конфигурация чанкинга и retry MUST задаваться через параметры
  запуска без изменения исходного кода.
- **FR-012**: Для каждого чанка система MUST сохранять стабильную связь между
  текстом чанка и его эмбеддингом.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Для тестового набора не менее 1 000 документов полный пайплайн
  должен завершаться не более чем за 30 минут на типовой среде проекта.
- **NFR-002**: Не менее 99% чанков в штатном запуске должны завершаться успехом
  генерации эмбеддинга без ручного вмешательства.
- **NFR-003**: Для 100% неуспешных чанков должна быть доступна классифицированная
  причина отказа.
- **NFR-004**: Повторный запуск на неизмененных данных не должен увеличивать
  число уникальных записей без фактического изменения источника.

### Assumptions

- Источники файлов уже прошли базовую фильтрацию до этапа чанкинга.
- Сервис генерации эмбеддингов может возвращать временные сбои, пригодные для
  retry-механики.
- Формат hash контента единый для всех файлов в рамках проекта.
- Метка времени обработки формируется в UTC.

### Key Entities *(include if feature involves data)*

- **ChunkingConfig**: параметры размера чанка, overlap и ограничений запуска.
- **ChunkRecord**: единица текста после чанкинга с порядковым номером и
  ссылкой на исходный файл.
- **EmbeddingTask**: состояние генерации эмбеддинга для конкретного чанка,
  включая retry-счетчик и результат.
- **VectorRecord**: сохраненная в индексе запись чанка с эмбеддингом и
  метаданными источника.
- **IngestionRunSummary**: сводка запуска пайплайна по количеству чанков,
  успехов, ошибок и повторных попыток.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% поддерживаемых файлов из контрольного набора
  успешно проходят этап чанкинга в одном запуске.
- **SC-002**: Не менее 99% чанков получают эмбеддинг и сохраняются в индекс в
  штатном сценарии без ручного перезапуска.
- **SC-003**: Для 100% сохраненных чанков доступны обязательные метаданные
  источника и времени обработки.
- **SC-004**: Повторный запуск на неизмененном наборе файлов изменяет количество
  записей не более чем на 1%.
- **SC-005**: Время первичной подготовки данных до готовности к поиску для
  контрольного набора не превышает 30 минут.

