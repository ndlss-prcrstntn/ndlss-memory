# Спецификация фичи: Безопасный запуск команд через MCP

**Feature Branch**: `007-secure-mcp-commands`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "Безопасный запуск команд через MCP: allowlist разрешенных команд, non-root, ограничения CPU/Memory, таймауты, структурированные ошибки, логирование вызовов, изоляция рабочих директорий"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Безопасный запуск разрешенных команд (Priority: P1)

Как пользователь MCP-агента, я хочу запускать только явно разрешенные команды с контролем времени выполнения, чтобы избежать случайного или вредоносного выполнения небезопасных операций.

**Why this priority**: Это базовый контур безопасности, без которого любые MCP-команды создают высокий риск для среды выполнения.

**Independent Test**: Отправить один разрешенный и один неразрешенный вызов команды; проверить, что разрешенный выполняется в пределах лимита времени, а неразрешенный стабильно отклоняется с машиночитаемой ошибкой.

**Acceptance Scenarios**:

1. **Given** команда входит в список разрешенных, **When** пользователь запускает ее через MCP, **Then** система выполняет команду и возвращает структурированный результат выполнения.
2. **Given** команда не входит в список разрешенных, **When** пользователь пытается запустить ее через MCP, **Then** система отклоняет запрос без запуска команды и возвращает машиночитаемую ошибку причины.
3. **Given** команда превышает допустимое время выполнения, **When** достигается лимит времени, **Then** система принудительно завершает выполнение и возвращает структурированный результат с признаком timeout.

---

### User Story 2 - Изоляция и ограничение ресурсов (Priority: P2)

Как владелец окружения, я хочу запускать команды с ограниченными правами и ресурсами, чтобы выполнение MCP-команд не влияло на стабильность хоста и соседних сервисов.

**Why this priority**: Ограничение прав и ресурсов снижает риск компрометации системы и деградации производительности.

**Independent Test**: Запустить команду в рабочей директории проекта и проверить, что выполнение не получает доступ вне разрешенной рабочей зоны, а также не превышает заданные лимиты CPU/Memory.

**Acceptance Scenarios**:

1. **Given** команда запускается через MCP, **When** создается процесс выполнения, **Then** процесс работает без привилегий администратора.
2. **Given** команда пытается обратиться к данным за пределами разрешенной рабочей директории, **When** выполняется проверка контекста, **Then** система блокирует выполнение и возвращает машиночитаемую ошибку изоляции.
3. **Given** команда потребляет ресурсы выше допустимого лимита, **When** превышение зафиксировано, **Then** система ограничивает или завершает выполнение с предсказуемым статусом ошибки.

---

### User Story 3 - Наблюдаемость и аудит вызовов (Priority: P3)

Как оператор системы, я хочу получать структурированные ошибки и журнал всех MCP-вызовов команд, чтобы быстро расследовать инциденты и подтверждать соблюдение политики безопасности.

**Why this priority**: Без аудита и диагностируемых ошибок невозможно эффективно поддерживать безопасность и операционную стабильность.

**Independent Test**: Выполнить успешный и неуспешный вызовы; проверить наличие записи аудита по каждому вызову и консистентную структуру ошибок для автоматической обработки.

**Acceptance Scenarios**:

1. **Given** команда завершилась успешно, **When** формируется ответ, **Then** система возвращает структурированный результат с кодом статуса и метаданными выполнения.
2. **Given** команда отклонена политикой безопасности, **When** формируется ответ, **Then** система возвращает машиночитаемый код ошибки и человекочитаемое пояснение.
3. **Given** выполнен любой вызов команды, **When** операция завершена, **Then** создается запись аудита с информацией о запрошенной команде, результате и причине отказа (если была ошибка).

---

### Edge Cases

- Пользователь передает пустую команду или только пробелы.
- Пользователь пытается обойти allowlist через модификацию аргументов.
- Команда завершается частичным успехом (код возврата не ноль, но с полезным выводом).
- Команда создает дочерние процессы, которые продолжают работу после таймаута.
- Команда содержит путь выхода за пределы рабочей директории.
- Система аудита временно недоступна в момент выполнения команды.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST проверять каждую запрошенную команду на соответствие allowlist до фактического запуска процесса.
- **FR-002**: Система MUST отклонять любые команды, отсутствующие в allowlist, и возвращать машиночитаемый код ошибки с поясняющим сообщением.
- **FR-003**: Система MUST применять ограничение времени выполнения для каждой команды и завершать выполнение при достижении лимита.
- **FR-004**: Система MUST запускать команды в ограниченном контексте привилегий (без административных прав).
- **FR-005**: Система MUST запускать команды только внутри разрешенной рабочей директории и отклонять попытки выхода за ее границы.
- **FR-006**: Система MUST применять ограничения CPU и Memory для выполняемых команд.
- **FR-007**: Система MUST возвращать единый структурированный формат результата как для успеха, так и для ошибок.
- **FR-008**: Система MUST логировать каждый вызов команды с минимумом полей: время, команда, результат, код ошибки (при наличии).
- **FR-009**: Система MUST сохранять журналы вызовов достаточно долго для операционного расследования и проверки политики безопасности.
- **FR-010**: Система MUST обновлять пользовательскую документацию при изменении поведения командного рантайма через MCP.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: 100% запросов на команды вне allowlist отклоняются без фактического запуска процесса.
- **NFR-002**: 100% команд, превысивших лимит времени, завершаются автоматически и получают статус timeout.
- **NFR-003**: 100% ответов об ошибках команд содержат машиночитаемый код ошибки и описание причины.
- **NFR-004**: Не менее 95% валидных командных запросов возвращают результат в пределах целевого времени, определенного политикой выполнения.

### Assumptions

- Политика allowlist управляется централизованно и доступна сервису выполнения команд.
- Каждому командному вызову соответствует один идентификатор запроса для трассировки в журнале.
- Политика безопасности допускает ограниченный набор утилит, необходимых для диагностических и операционных задач.

### Key Entities *(include if feature involves data)*

- **CommandExecutionRequest**: идентификатор запроса, имя команды, аргументы, рабочая директория, инициатор вызова.
- **CommandPolicy**: список разрешенных команд, лимит времени, лимиты CPU/Memory, правила изоляции директории.
- **CommandExecutionResult**: итоговый статус выполнения, код возврата, выходные данные, код ошибки, длительность.
- **CommandAuditRecord**: время события, запрошенная команда, примененная политика, результат, причина отказа, идентификатор трассировки.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% попыток запуска неразрешенных команд блокируются и возвращают машиночитаемую ошибку причины.
- **SC-002**: 100% команд, превышающих лимит времени, автоматически останавливаются и помечаются как timeout.
- **SC-003**: Не менее 95% разрешенных команд завершаются с ответом менее чем за 5 секунд на эталонном тестовом наборе.
- **SC-004**: Для 100% вызовов команд создается запись аудита, содержащая минимум команду, статус и timestamp.
- **SC-005**: Оператор может определить причину отказа команды по структурированному ответу и журналу не более чем за 1 минуту.
