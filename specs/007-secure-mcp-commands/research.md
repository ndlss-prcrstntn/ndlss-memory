# Research: Безопасный запуск команд через MCP

## Контекст

Фича: `007-secure-mcp-commands`
Цель: зафиксировать безопасные правила выполнения команд MCP и наблюдаемости без
добавления новых сервисов.

## Исследовательские задачи

- Task: "Find best practices for allowlist-based command execution in MCP runtimes"
- Task: "Find patterns for timeout enforcement and deterministic process termination"
- Task: "Find best practices for non-root execution, resource limits, and workspace isolation in containerized command runners"
- Task: "Find structured error and audit logging patterns for operator investigations"

## Решения

### Decision: Выполнять команды только после allowlist-проверки по имени команды
- Rationale: гарантирует, что запрещенная команда не стартует даже при валидных аргументах.
- Alternatives considered:
  - Проверять только префикс/substring команды: отклонено как уязвимое к обходам.
  - Разрешать любую команду с denylist: отклонено как менее безопасная модель.

### Decision: Применять жесткий timeout с принудительным завершением процесса и дочерних процессов
- Rationale: исключает зависшие процессы и неконтролируемое потребление ресурсов.
- Alternatives considered:
  - Только soft-timeout без принудительного завершения: отклонено из-за риска зависания.
  - Не ограничивать время для "доверенных" команд: отклонено как операционный риск.

### Decision: Использовать non-root execution и ресурсные ограничения на уровне контейнера с явной политикой
- Rationale: снижает поверхность атаки и предотвращает деградацию соседних сервисов.
- Alternatives considered:
  - Запуск от root с проверками только в приложении: отклонено как недостаточно безопасно.
  - Лимиты только на уровне приложения: отклонено как менее надежное ограничение.

### Decision: Изоляцию рабочей директории реализовать через canonical-path проверку и запрет выхода за корень workspace
- Rationale: исключает path traversal и доступ к нежелательным путям хоста.
- Alternatives considered:
  - Полагаться только на текущую директорию процесса: отклонено как недостаточно строго.
  - Разрешать относительные пути без нормализации: отклонено из-за риска обхода.

### Decision: Формат ошибок и аудита унифицировать как машиночитаемые записи с requestId
- Rationale: обеспечивает автоматическую обработку клиентами и быстрый операторский разбор инцидентов.
- Alternatives considered:
  - Текстовые ошибки без кодов: отклонено как непригодное для автоматики.
  - Логировать только неуспешные вызовы: отклонено, теряется полный аудит.

### Decision: Минимальный срок хранения аудита в рантайме — 7 дней
- Rationale: покрывает типичный период расследования инцидентов без существенного усложнения.
- Alternatives considered:
  - Хранить только в памяти текущего процесса: отклонено, записи теряются после рестарта.
  - Бессрочное хранение в рамках контейнера: отклонено как неограниченный рост данных.

## Outcome

`NEEDS CLARIFICATION` отсутствуют; решения по allowlist, timeout, non-root,
resource limits, workspace isolation, structured errors и аудиту зафиксированы.
