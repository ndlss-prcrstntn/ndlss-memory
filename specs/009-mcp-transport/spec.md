# Спецификация фичи: MCP Transport Compatibility

**Feature Branch**: `009-mcp-transport`  
**Created**: 2026-02-22  
**Status**: Draft  
**Input**: User description: "Чтобы было удобно пользоваться из VS Code/Claude/Cline как MCP, не хватает настоящего MCP транспорта, MCP JSON-RPC методов, маппинга REST ручек в MCP tools, единого формата ошибок, рабочих клиентских конфигураций и контрактных тестов MCP транспорта."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Подключение MCP клиентов (Priority: P1)

Как пользователь MCP-клиента (VS Code/Claude/Cline), я хочу подключаться к серверу через стандартный MCP transport и успешно проходить MCP handshake, чтобы сервер распознавался как полноценный MCP endpoint, а не только REST API.

**Why this priority**: Без корректного MCP transport остальные MCP-возможности недоступны в клиентах, даже если бизнес-логика уже есть.

**Independent Test**: MCP-совместимый клиент подключается к серверу по документированному URL и успешно выполняет `initialize`, `notifications/initialized`, `ping` без ручных обходов.

**Acceptance Scenarios**:

1. **Given** поднятый сервер и корректный URL MCP transport, **When** клиент отправляет `initialize`, **Then** сервер возвращает валидный MCP-ответ с заявленными возможностями.
2. **Given** завершенный handshake, **When** клиент отправляет `ping`, **Then** сервер отвечает без ошибки и соединение остается активным.
3. **Given** клиент запрашивает discovery endpoint, **When** discovery включен, **Then** клиент получает валидную информацию о доступном MCP transport.

---

### User Story 2 - Использование MCP инструментов (Priority: P2)

Как пользователь MCP-клиента, я хочу видеть инструменты через `tools/list` и вызывать их через `tools/call`, чтобы выполнять поиск, получать источник/метаданные и запускать индексирующие операции без прямых REST-запросов.

**Why this priority**: После подключения клиенту нужна прикладная ценность; именно tools делают интеграцию полезной в ежедневной работе.

**Independent Test**: После handshake клиент получает каталог инструментов, вызывает минимум три ключевых инструмента, и каждый вызов возвращает структурированный результат или структурированную MCP-ошибку.

**Acceptance Scenarios**:

1. **Given** активное MCP-соединение, **When** клиент вызывает `tools/list`, **Then** получает список поддерживаемых инструментов с понятными входными параметрами.
2. **Given** индексированные данные, **When** клиент вызывает инструмент семантического поиска, **Then** получает структурированный список результатов с идентификаторами для последующей детализации.
3. **Given** невалидные параметры инструмента, **When** клиент выполняет `tools/call`, **Then** сервер возвращает машиночитаемую JSON-RPC ошибку с кодом и диагностическими данными.

---

### User Story 3 - Предсказуемый онбординг и совместимость (Priority: P3)

Как пользователь или администратор, я хочу иметь готовые клиентские конфиги и проверяемые контрактные/smoke тесты MCP транспорта, чтобы быстро подключать новые клиенты и не ломать совместимость при релизах.

**Why this priority**: Это снижает стоимость внедрения и уменьшает регрессии при изменениях протокольного слоя.

**Independent Test**: Пользователь использует готовый пример конфигурации для выбранного клиента и подключается с первой попытки; regression-набор MCP тестов проходит в CI.

**Acceptance Scenarios**:

1. **Given** новый пользователь с поддерживаемым MCP-клиентом, **When** он применяет пример конфигурации из документации, **Then** клиент подключается без ручного подбора transport URL.
2. **Given** новый релиз сервера, **When** выполняется CI-проверка MCP контракта, **Then** тесты подтверждают корректность handshake, tools и формата ошибок.

---

### Edge Cases

- Клиент отправляет JSON-RPC метод, который не поддерживается сервером.
- Клиент вызывает `tools/call` с отсутствующими обязательными параметрами.
- Во время `tools/call` транспорт обрывается или превышается таймаут.
- Сервер работает, но индекс еще не построен: поиск возвращает пустой результат без protocol-level ошибки.
- Discovery endpoint отключен или недоступен: клиенту должен быть доступен альтернативный явный URL transport.
- Одновременно подключаются несколько клиентов и запрашивают `tools/list`/`tools/call`.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST предоставлять MCP-совместимый transport endpoint для JSON-RPC взаимодействия клиентов.
- **FR-002**: Система MUST поддерживать как минимум один стандартный MCP transport режим для подключения клиентов VS Code/Claude/Cline.
- **FR-003**: Система MUST поддерживать MCP методы `initialize`, `notifications/initialized`, `ping`.
- **FR-004**: Система MUST поддерживать MCP методы `tools/list` и `tools/call`.
- **FR-005**: Система MUST предоставить инструменты, покрывающие ключевые текущие операции: семантический поиск, получение источника по ID, получение метаданных по ID, запуск и проверка статуса индексации.
- **FR-006**: Каждый MCP инструмент MUST иметь формально описанные входные параметры, ограничения и структуру успешного ответа.
- **FR-007**: Ошибки инструментов и транспортные ошибки MUST возвращаться как машиночитаемые JSON-RPC ошибки с предсказуемыми кодами и полями данных.
- **FR-008**: Если поддерживается discovery, система MUST публиковать discovery endpoint с актуальной информацией для MCP клиента.
- **FR-009**: Система MUST сохранять обратную совместимость существующего REST API для текущих интеграций.
- **FR-010**: Система MUST включать готовые примеры клиентских конфигураций минимум для VS Code, Claude Desktop и Cline/Roo.
- **FR-011**: Система MUST включать контрактные тесты MCP транспорта (handshake, tools/list, tools/call, error format).
- **FR-012**: Система MUST включать smoke-тест совместимости с MCP-клиентом/инспектором в автоматизированном наборе проверок.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Клиент должен получать первый успешный ответ на MCP handshake не более чем за 5 секунд при локальном запуске стека в штатном состоянии.
- **NFR-002**: Формат ответов и ошибок MCP должен быть стабильным между патч-релизами.
- **NFR-003**: Сервер должен поддерживать минимум 5 одновременных MCP-сессий без деградации корректности ответов.
- **NFR-004**: Документация подключения MCP должна быть достаточной для запуска без чтения исходного кода.

### Assumptions

- MCP transport разворачивается в локальной доверенной среде разработки.
- Базовые поисковые и индексирующие операции уже реализованы на стороне REST и доступны для адаптации в MCP tools.
- Клиенты используют стандартный JSON-RPC формат MCP и не требуют нестандартных vendor-расширений для базового сценария.

### Key Entities *(include if feature involves data)*

- **McpSession**: идентификатор сессии, статус handshake, время открытия, последнее событие.
- **McpToolDefinition**: имя инструмента, описание, схема входных параметров, схема результата, версия контракта.
- **McpToolInvocation**: request id, имя инструмента, аргументы, итоговый статус, код/детали ошибки, длительность.
- **McpTransportDescriptor**: тип transport, публичный URL, поддерживаемые возможности и discovery-метаданные.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% попыток подключения поддерживаемых MCP-клиентов завершаются успешным handshake с первой попытки по документации.
- **SC-002**: 100% обязательных MCP методов (`initialize`, `notifications/initialized`, `ping`, `tools/list`, `tools/call`) проходят контрактные тесты в CI.
- **SC-003**: Не менее 95% успешных `tools/call` на типовом локальном наборе данных возвращают ответ менее чем за 3 секунды.
- **SC-004**: Для 100% негативных сценариев из контрактных тестов сервер возвращает валидную JSON-RPC ошибку с ожидаемым кодом.
- **SC-005**: Новый пользователь подключает хотя бы один поддерживаемый MCP-клиент и выполняет первый полезный `tools/call` не более чем за 10 минут по документации.

