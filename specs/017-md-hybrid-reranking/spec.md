# Спецификация фичи: Reranking поверх hybrid поиска для markdown

**Feature Branch**: `017-md-hybrid-reranking`
**Created**: 2026-02-23
**Status**: Draft
**Input**: User description: "Reranking поверх hybrid только для md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Улучшить релевантность docs-поиска вторым этапом ранжирования (Priority: P1)

Пользователь выполняет запрос по документации и получает более точный порядок результатов за счет reranking после первичного hybrid-отбора.

**Why this priority**: Основная ценность фичи — повысить качество top-результатов при поиске по markdown-документам.

**Independent Test**: На контрольном наборе docs-запросов сравнить выдачу до/после и подтвердить, что релевантные документы чаще попадают в верхние позиции.

**Acceptance Scenarios**:

1. **Given** markdown-коллекция содержит несколько близких по смыслу документов, **When** пользователь запускает поиск, **Then** итоговый порядок результатов формируется reranking-этапом поверх hybrid-кандидатов.
2. **Given** пользовательский запрос содержит и точные термины, и более общий контекст, **When** поиск завершен, **Then** в top-выдаче представлены наиболее релевантные документы по совокупной оценке.

---

### User Story 2 - Ограничить reranking только markdown-потоком (Priority: P2)

Владелец продукта хочет применить reranking только для docs-поиска по markdown-коллекции, не затрагивая прочие типы поиска.

**Why this priority**: Локальный rollout снижает риск регрессий и сохраняет предсказуемость существующих сценариев.

**Independent Test**: Проверить, что non-docs эндпоинты и non-markdown сценарии работают без изменений поведения и формата ответа.

**Acceptance Scenarios**:

1. **Given** пользователь обращается к docs-поиску, **When** выполняется запрос, **Then** reranking применяется к markdown-кандидатам.
2. **Given** пользователь обращается к non-docs поиску, **When** выполняется запрос, **Then** reranking не применяется и поведение остается прежним.

---

### User Story 3 - Стабильный и надежный пользовательский опыт при reranking (Priority: P3)

Пользователь получает предсказуемую выдачу и корректные ответы даже при пустых результатах или временных проблемах reranking-этапа.

**Why this priority**: Улучшение качества поиска должно сохранять стабильность UX и отказоустойчивость.

**Independent Test**: Повторить идентичные запросы на неизменном индексе и проверить стабильность top-k; проверить fallback при недоступности reranking-этапа.

**Acceptance Scenarios**:

1. **Given** reranking-этап временно недоступен, **When** пользователь выполняет docs-запрос, **Then** система возвращает корректный результат через fallback без падения запроса.
2. **Given** пользователь повторяет один и тот же запрос при неизменных данных, **When** результаты получены, **Then** порядок top-результатов остается консистентным.

---

### Edge Cases

- В markdown-коллекции недостаточно кандидатов для reranking (например, 0 или 1 документ).
- Все кандидаты имеют близкие оценки, и требуется детерминированный tie-break.
- Запрос содержит только редкие термины, которые почти не представлены в документации.
- Reranking-этап недоступен или вернул неполный результат.
- В markdown-коллекции данные обновились между последовательными запросами.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST выполнять reranking как второй этап после первичного hybrid-отбора кандидатов для docs-поиска.
- **FR-002**: Reranking MUST применяться только для поиска по markdown-коллекции и MUST NOT изменять поведение non-docs поиска.
- **FR-003**: Система MUST возвращать единый итоговый порядок результатов после reranking-этапа.
- **FR-004**: При недоступности reranking-этапа система MUST использовать контролируемый fallback к результатам первичного hybrid-этапа.
- **FR-005**: Система MUST обеспечивать детерминированный порядок результатов при равных итоговых оценках.
- **FR-006**: Ответ docs-поиска MUST явно отражать примененную стратегию ранжирования.
- **FR-007**: Невалидные запросы MUST обрабатываться машиночитаемой ошибкой без запуска поиска.
- **FR-008**: Изменение логики ранжирования MUST сопровождаться обновлением пользовательской документации и quickstart.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Для 95% docs-запросов пользователь MUST получать итоговую выдачу не более чем за 3 секунды при типичной нагрузке проекта.
- **NFR-002**: На неизменном наборе данных доля совпадения top-5 результатов для повторных одинаковых запросов MUST быть не ниже 90%.
- **NFR-003**: Доля успешных fallback-ответов при деградации reranking-этапа MUST быть не ниже 99% без критических ошибок для пользователя.
- **NFR-004**: Non-docs поиск MUST сохранять текущие показатели корректности и формата ответа без регрессии.

### Key Entities *(include if feature involves data)*

- **HybridCandidateSet**: набор документов-кандидатов после первичного hybrid-ранжирования для docs-поиска.
- **RerankedResultItem**: результат после второго этапа ранжирования с итоговой позицией и оценкой релевантности.
- **RerankingPolicy**: правила reranking (область применения, порядок fallback, tie-break стратегия).
- **CollectionScopeRule**: правило, определяющее, что reranking активен только для markdown-коллекции.

## Assumptions

- В продукте уже реализован первичный hybrid docs-поиск по markdown-коллекции.
- Пользовательский интерфейс и текущие точки входа docs-поиска остаются прежними.
- Для приемки доступен контрольный набор запросов для сравнения качества выдачи до и после reranking.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 90% контрольных docs-запросов возвращают релевантный результат в top-3 после включения reranking.
- **SC-002**: По сравнению с baseline hybrid без reranking, доля релевантных попаданий в top-3 увеличивается минимум на 10%.
- **SC-003**: Для 95% docs-запросов итоговая выдача возвращается менее чем за 3 секунды.
- **SC-004**: В 100% контрольных проверок non-docs поиск сохраняет прежний формат и поведение.
