# Спецификация фичи: Непрерывный Watch Mode

**Feature Branch**: `013-watch-mode-indexing`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "Add continuous watch mode (INDEX_MODE=watch) for incremental indexing..."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Автообновление поиска (Priority: P1)

Как оператор, я включаю `INDEX_MODE=watch` и после изменения файлов вижу обновленные результаты поиска без ручного запуска задач индексации.

**Why this priority**: Это ключевая пользовательская ценность режима watch: убрать ручные шаги между изменением кода и актуальным поиском.

**Independent Test**: Запустить стек в режиме watch, изменить/добавить/удалить файлы в workspace и убедиться, что поисковые результаты обновились без ручного API-триггера.

**Acceptance Scenarios**:

1. **Given** стек запущен в режиме watch и индекс уже доступен, **When** пользователь добавляет новый поддерживаемый файл, **Then** содержимое файла становится доступным в поиске без ручного запуска job.
2. **Given** стек запущен в режиме watch, **When** пользователь изменяет содержимое существующего файла, **Then** поиск отражает новую версию содержимого, а устаревшие фрагменты не возвращаются как актуальные.
3. **Given** стек запущен в режиме watch, **When** пользователь удаляет файл, **Then** соответствующие данные исчезают из поисковой выдачи после обработки события.

---

### User Story 2 - Устойчивый наблюдатель (Priority: P2)

Как оператор, я хочу, чтобы watch-режим оставался работоспособным при всплесках изменений и кратковременных ошибках.

**Why this priority**: Без устойчивости watch-режим перестает быть надежным в реальных проектах с интенсивной активностью файлов.

**Independent Test**: Сгенерировать burst изменений и искусственно вызвать ошибки наблюдателя; убедиться, что режим продолжает работу и позже обрабатывает новые изменения.

**Acceptance Scenarios**:

1. **Given** в workspace происходит серия быстрых изменений, **When** система обрабатывает поток событий, **Then** watch-режим не останавливается и индекс остается консистентным.
2. **Given** возникает временная ошибка наблюдения файловой системы, **When** ошибка обработана политикой повторов, **Then** watch-режим восстанавливается без ручного рестарта сервиса.

---

### User Story 3 - Прозрачный статус watch (Priority: P3)

Как оператор, я вижу активность watch-режима в логах и статусных endpoint, чтобы быстро понимать текущее состояние и причины проблем.

**Why this priority**: Наблюдаемость нужна для эксплуатации и быстрой диагностики, особенно при фоновой непрерывной обработке.

**Independent Test**: Проверить, что API статусов и логи показывают состояние watch, последние обработанные события и ошибки с объяснением действий для восстановления.

**Acceptance Scenarios**:

1. **Given** watch-режим активен, **When** оператор запрашивает статус системы/индексации, **Then** он получает явный признак активности watch и сводку последних обработанных изменений.
2. **Given** в watch-режиме произошла ошибка, **When** оператор проверяет логи и статус, **Then** он видит структурированную причину ошибки и текущее состояние восстановления.

---

### Edge Cases

- Серия переименований и удалений одного и того же файла за короткое время.
- Множественные изменения одного файла до завершения предыдущей обработки.
- Изменения в неподдерживаемых типах файлов и в исключенных директориях.
- Временная недоступность зависимостей во время обработки watch-событий.
- Запуск watch-режима в почти пустом workspace с редкими изменениями.

### Assumptions

- Watch-режим используется для рабочих директорий, где ожидаются частые инкрементальные изменения.
- Ручные операции индексации остаются доступными как fallback для оператора.
- Базовые режимы индексации должны сохранять текущее поведение без регрессий.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать `INDEX_MODE=watch` как отдельный рабочий режим непрерывной индексации.
- **FR-002**: В режиме watch система MUST обнаруживать события создания, изменения и удаления файлов в workspace.
- **FR-003**: В режиме watch система MUST переиндексировать только затронутые файлы, а не выполнять полный проход workspace при каждом событии.
- **FR-004**: При удалении файла система MUST удалять или деактивировать соответствующие данные из поискового индекса.
- **FR-005**: Система MUST применять безопасную политику повторов с backoff при ошибках наблюдателя или обработки событий.
- **FR-006**: Ошибки watch-обработки MUST не приводить к необратимой остановке наблюдателя без возможности автоматического восстановления.
- **FR-007**: Система MUST публиковать активность watch-режима в логах в структурированном и операционно-понятном виде.
- **FR-008**: Система MUST отражать состояние watch-режима и результат последней обработки в статусных/summary API.
- **FR-009**: Режимы `full-scan` и `delta-after-commit` MUST сохранять текущее поведение без изменения пользовательского контракта.
- **FR-010**: Документация MUST содержать сценарий запуска и проверки watch-режима, включая диагностику типовых ошибок.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: При типичном изменении одного файла обновление поисковой выдачи должно происходить не позднее 60 секунд после изменения.
- **NFR-002**: Watch-режим должен выдерживать burst не менее 100 файловых событий за 60 секунд без необратимой остановки.
- **NFR-003**: После временной ошибки наблюдателя система должна восстановить обработку новых событий не позднее чем за 2 минуты.
- **NFR-004**: Изменения для watch-режима не должны ухудшать поведение и доступность существующих режимов индексации.

### Key Entities *(include if feature involves data)*

- **WatchEvent**: событие изменения файла (тип события, путь, время обнаружения, статус обработки).
- **WatchRunState**: текущее состояние наблюдателя (активен/восстанавливается/ошибка), время последнего heartbeat, статистика событий.
- **IncrementalIndexResult**: результат обработки события (затронутые файлы, обновленные записи, удаленные записи, ошибки).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В режиме watch изменения файлов отражаются в поиске без ручного запуска job в 95% случаев в пределах 60 секунд.
- **SC-002**: При сценарии burst-изменений watch-режим завершает обработку очереди без ручного перезапуска и сохраняет состояние `running`.
- **SC-003**: При искусственно вызванных временных ошибках наблюдатель автоматически возвращается в рабочее состояние и продолжает обработку новых изменений.
- **SC-004**: Для оператора доступен единый наблюдаемый статус watch-режима через логи и API в 100% проверочных запусков.
