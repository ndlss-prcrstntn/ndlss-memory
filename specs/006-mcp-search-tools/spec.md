# Спецификация фичи: MCP-инструменты поиска

**Feature Branch**: `006-mcp-search-tools`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "MCP-инструменты поиска: semantic search, получить источник по ID, получить метаданные документа, фильтрация по пути/папке/типу файла, структурированный ответ, обработка пустых результатов"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Семантический поиск по индексу (Priority: P1)

Как пользователь MCP-агента, я хочу запускать semantic search по рабочему
индексу, чтобы быстро находить релевантные фрагменты контента.

**Why this priority**: Это основной пользовательский сценарий поиска и базовая
ценность memory-слоя.

**Independent Test**: Выполнить поисковый запрос по тестовому набору с известной
релевантностью и проверить, что результаты возвращаются в структурированном виде
с непустым списком найденных совпадений.

**Acceptance Scenarios**:

1. **Given** в индексе есть документы по теме запроса, **When** пользователь
   вызывает semantic search, **Then** система возвращает структурированный список
   релевантных результатов.
2. **Given** задан ограничивающий параметр количества результатов, **When**
   выполняется semantic search, **Then** система возвращает не больше указанного
   количества элементов.

---

### User Story 2 - Получение источника и метаданных по ID (Priority: P2)

Как пользователь MCP-агента, я хочу получить исходный контент и метаданные
документа по ID, чтобы понимать происхождение найденного результата.

**Why this priority**: Без трассируемости результатов поиск теряет практическую
ценность для анализа и последующих действий.

**Independent Test**: По ID результата из semantic search запросить источник и
метаданные и проверить, что возвращаются корректные поля идентификации и пути.

**Acceptance Scenarios**:

1. **Given** существует валидный ID результата, **When** вызывается инструмент
   получения источника, **Then** возвращается связанный исходный фрагмент.
2. **Given** существует валидный ID результата, **When** вызывается инструмент
   получения метаданных, **Then** возвращаются структурированные метаданные
   документа.

---

### User Story 3 - Фильтрация и устойчивость ответов (Priority: P3)

Как пользователь MCP-агента, я хочу фильтровать поиск по пути, папке и типу
файла, а также получать предсказуемый ответ при пустой выдаче.

**Why this priority**: Это повышает точность поиска и исключает неопределенное
поведение в пограничных сценариях.

**Independent Test**: Выполнить поиск с фильтрами, затем запрос без совпадений,
и проверить корректность применения фильтров и пустого результата.

**Acceptance Scenarios**:

1. **Given** в запросе указаны фильтры пути/папки/типа файла, **When**
   выполняется поиск, **Then** в выдаче остаются только элементы, соответствующие
   всем заданным ограничениям.
2. **Given** запрос не имеет совпадений, **When** выполняется поиск, **Then**
   система возвращает структурированный пустой ответ без внутренней ошибки.

---

### Edge Cases

- Поисковый запрос пустой или состоит только из пробелов.
- Запрошен несуществующий ID источника.
- Передан некорректный формат фильтра пути/папки/типа.
- Поиск возвращает очень большой набор совпадений при широком запросе.
- Метаданные документа частично отсутствуют у отдельной записи.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST предоставлять MCP-инструмент semantic search по
  индексированному контенту.
- **FR-002**: Система MUST предоставлять MCP-инструмент получения источника по
  идентификатору результата.
- **FR-003**: Система MUST предоставлять MCP-инструмент получения метаданных
  документа по идентификатору результата.
- **FR-004**: Semantic search MUST поддерживать фильтрацию по пути файла.
- **FR-005**: Semantic search MUST поддерживать фильтрацию по папке.
- **FR-006**: Semantic search MUST поддерживать фильтрацию по типу файла.
- **FR-007**: Система MUST возвращать структурированный ответ для каждого
  инструмента поиска с предсказуемыми полями статуса и данных.
- **FR-008**: При отсутствии совпадений semantic search MUST возвращать
  структурированный пустой результат, а не ошибку выполнения.
- **FR-009**: При запросе по несуществующему ID система MUST возвращать
  машиночитаемую ошибку с кодом причины.
- **FR-010**: Результаты semantic search MUST содержать ссылку на источник,
  достаточную для последующего вызова инструмента получения источника/метаданных.
- **FR-011**: Изменения поведения MCP-инструментов поиска MUST быть отражены в
  пользовательской документации проекта.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Не менее 95% поисковых запросов на эталонном наборе данных
  возвращают ответ менее чем за 2 секунды.
- **NFR-002**: Для 100% ответов инструментов поиска соблюдается единый
  структурированный формат результата.
- **NFR-003**: Для 100% неуспешных запросов доступны машиночитаемые коды ошибок.

### Assumptions

- Релевантный контент уже присутствует в индексе к моменту выполнения поиска.
- Идентификатор результата однозначно указывает на источник и связанные
  метаданные.
- Фильтры пути, папки и типа файла применяются совместно (логическое И).

### Key Entities *(include if feature involves data)*

- **SearchQuery**: текст запроса, ограничение количества результатов, набор
  фильтров (путь, папка, тип файла).
- **SearchResult**: идентификатор результата, оценка релевантности, ссылка на
  источник, фрагмент контента.
- **DocumentSource**: исходный фрагмент/документ, связанный с идентификатором
  результата.
- **DocumentMetadata**: структурированные атрибуты документа (путь, имя файла,
  тип файла, время индексации и связанные поля).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 90% тестовых поисковых запросов возвращают хотя бы один
  релевантный результат в первых 5 позициях выдачи.
- **SC-002**: Для 100% валидных ID инструменты получения источника и метаданных
  возвращают данные без ошибок формата.
- **SC-003**: Для 100% запросов без совпадений система возвращает корректный
  структурированный пустой ответ.
- **SC-004**: Не менее 95% запросов semantic search завершаются менее чем за 2
  секунды на целевом тестовом наборе.
- **SC-005**: Пользователь может пройти путь "поиск -> источник -> метаданные"
  менее чем за 1 минуту без ручной донастройки окружения.
