# Research: Startup Preflight Checks and Ready Summary

## Decision 1: Включить обязательный startup preflight до запуска рабочих воркеров

- **Decision**: Выполнять preflight-проверки синхронно в startup-пути сервисов до перехода в ready-состояние и до запуска фоновых задач индексации.
- **Rationale**: Это гарантирует fail-fast поведение и исключает «полуживое» состояние, когда контейнер формально запущен, но неработоспособен по критичным зависимостям.
- **Alternatives considered**:
  - Отложенная проверка на первом API-запросе.
    - Отклонено: оператор получает ошибку слишком поздно, сложнее диагностика.
  - Только периодический healthcheck без блокировки старта.
    - Отклонено: не обеспечивает fail-fast и предсказуемый запуск.

## Decision 2: Считать Qdrant и workspace критичными startup-зависимостями

- **Decision**: Проверки доступности Qdrant и валидности/читаемости `WORKSPACE_PATH` являются обязательными и блокирующими старт.
- **Rationale**: Без Qdrant и рабочего workspace основные функции индексации/поиска не выполняются; запуск без них вводит в заблуждение.
- **Alternatives considered**:
  - Разрешить degraded-start без Qdrant.
    - Отклонено: противоречит цели явной готовности к реальной работе.
  - Проверять только существование пути workspace, без читаемости.
    - Отклонено: приводит к поздним ошибкам доступа на этапе индексации.

## Decision 3: Git проверять условно по активному режиму

- **Decision**: Проверка git обязательна только при git-зависимом режиме (`INDEX_MODE=delta-after-commit` или включенных git-зависимых bootstrap-сценариях).
- **Rationale**: Для `full-scan` git не является критичной зависимостью, поэтому проверка не должна искусственно блокировать валидные сценарии.
- **Alternatives considered**:
  - Всегда требовать git.
    - Отклонено: ломает сценарии без git-репозитория и не дает пользы для full-scan.
  - Никогда не проверять git на старте.
    - Отклонено: ошибки всплывают поздно при запуске delta-процесса.

## Decision 4: Единый формат fail-fast ошибок старта

- **Decision**: Использовать единый структурированный формат startup-ошибки: `errorCode`, `message`, `details`, `action`, `failedChecks[]`.
- **Rationale**: Формат остается совместимым с текущими API-ошибками (`errorCode`/`message`) и одновременно дает оператору/автоматике достаточный контекст для быстрого исправления.
- **Alternatives considered**:
  - Только текстовые логи без структуры.
    - Отклонено: плохо автоматизируется и ухудшает поддержку.
  - Новый полностью отдельный формат ошибок.
    - Отклонено: добавляет лишнюю несовместимость в экосистеме.

## Decision 5: Ready summary должен быть единым и стабильным

- **Decision**: После успешного preflight публиковать одну агрегированную startup-summary запись с фиксированными полями: `serviceReadiness`, `workspacePath`, `indexMode`, `mcpEndpoint`, `collectionName`, `checkedAt`.
- **Rationale**: Оператору нужен один источник истины, который можно быстро прочитать глазами и парсить автоматически.
- **Alternatives considered**:
  - Разрозненные сообщения по каждому сервису.
    - Отклонено: сложнее быстро понять общий статус.
  - Summary только в API, без логов.
    - Отклонено: усложняет первичную диагностику через `docker compose logs`.

## Decision 6: Сохранить backward compatibility compose preset и API

- **Decision**: Не менять существующие endpoint и их базовую семантику; расширять только startup-валидацию, логирование и диагностические поля без breaking changes.
- **Rationale**: Фича должна улучшить эксплуатацию без миграций пользовательских сценариев.
- **Alternatives considered**:
  - Редизайн системных endpoint под startup-статус.
    - Отклонено: высокий риск регрессии и лишний объем изменений.
