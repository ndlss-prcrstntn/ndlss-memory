# Спецификация фичи: Отдельная docs-коллекция и baseline docs-поиск

**Feature Branch**: `[015-docs-index-baseline]`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "docs-collection-indexing Отдельная md-коллекция и стабильная индексация. docs-search-baseline Простой поиск только по docs (без hybrid/rerank), чтобы зафиксировать контракт и метрики baseline."

## Clarifications

### Session 2026-02-22

- Q: Какое правило уникальности применяется для docs-индекса? → A: Документ уникален по нормализованному пути, чанк уникален по `path + stable chunk index`, хеш используется для детекта изменений.
- Q: Когда должна создаваться docs-коллекция? → A: Коллекция создается на старте и дополнительно должна самовосстанавливаться при отсутствии во время операций записи или удаления.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Изолированная индексация документации (Priority: P1)

Как владелец репозитория, я хочу, чтобы документация индексировалась отдельно от кода, чтобы поисковая выдача по документации не содержала шум из реализации.

**Why this priority**: Без отдельной индексации docs невозможно получить чистый контекст по проектной документации и baseline для дальнейшего улучшения качества поиска.

**Independent Test**: На репозитории с markdown-файлами и исходным кодом запустить индексирование и проверить, что в docs-коллекцию попали только markdown-документы, а файлы кода отсутствуют.

**Acceptance Scenarios**:

1. **Given** репозиторий содержит markdown и кодовые файлы, **When** запускается полная индексация, **Then** docs-коллекция содержит только документы markdown.
2. **Given** ранее уже выполнялась индексация без изменений файлов, **When** выполняется повторный запуск, **Then** дубликаты документов и фрагментов не создаются.
3. **Given** изменился только markdown-файл, **When** выполняется инкрементальный запуск, **Then** обновляется только соответствующая запись документации с сохранением правил отбора.

---

### User Story 2 - Базовый поиск только по документации (Priority: P2)

Как пользователь MCP-клиента, я хочу выполнять отдельный поиск только по документации проекта, чтобы быстро находить описания, инструкции и концепции без результатов из исходного кода.

**Why this priority**: После изолированной индексации пользовательская ценность появляется только тогда, когда можно отдельно запрашивать docs-поиск и получать предсказуемый baseline-результат.

**Independent Test**: Выполнить docs-поиск по набору контрольных запросов и подтвердить, что результаты берутся только из документации и возвращаются в стабильном порядке при неизменных данных.

**Acceptance Scenarios**:

1. **Given** docs-коллекция содержит релевантные документы, **When** пользователь выполняет docs-поиск, **Then** система возвращает только результаты документации с достаточной информацией об источнике.
2. **Given** в docs-коллекции нет релевантных совпадений, **When** пользователь выполняет docs-поиск, **Then** система возвращает явный пустой результат без ошибки.
3. **Given** данные документации не менялись, **When** один и тот же docs-запрос выполняется повторно, **Then** топ результатов остается детерминированным.

---

### Edge Cases

- Репозиторий не содержит markdown-документов.
- Документы были удалены или перемещены между запусками индексации.
- Документы содержат очень короткий или служебный текст, не дающий полезных совпадений.
- Запрос docs-поиска совпадает с терминами, которые чаще встречаются в коде, но отсутствуют в документации.
- В репозитории есть смешанные форматы документации, часть которых не должна попадать в docs-коллекцию.

## Assumptions

- Под документацией в рамках этой фичи понимаются markdown-файлы репозитория.
- Область фичи ограничена изолированной docs-индексацией и baseline docs-поиском без hybrid и rerank.
- Текущие сценарии поиска по коду должны оставаться функционально совместимыми и не менять ожидаемое поведение пользователей.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать отдельную индексную область для документации, не смешивая документы с кодовыми фрагментами.
- **FR-002**: Система MUST включать в docs-индексацию только markdown-документы в рамках заданной области сканирования.
- **FR-003**: Система MUST применять единые правила отбора документов как для полного, так и для инкрементального индексирования.
- **FR-004**: Повторная индексация без изменений MUST не создавать дубликаты документов и их фрагментов.
- **FR-005**: Система MUST предоставлять отдельный baseline docs-поиск, который использует только docs-индекс.
- **FR-006**: Результат docs-поиска MUST включать идентификатор источника, путь документа и текстовый фрагмент для верификации результата пользователем.
- **FR-007**: При отсутствии совпадений docs-поиск MUST возвращать явный пустой результат с признаком успешного выполнения.
- **FR-008**: Сводка запуска индексирования MUST содержать количество обработанных документов, пропущенных файлов и причины пропуска.
- **FR-009**: Публичное описание поведения docs-индексации и docs-поиска MUST быть обновлено в пользовательской документации.
- **FR-010**: Введение docs-коллекции MUST не нарушать существующее поведение основного поиска по коду.
- **FR-011**: Правило уникальности docs-индекса MUST быть фиксированным: документ определяется нормализованным путем, фрагмент определяется `path + stable chunk index`, а факт изменения определяется хешем содержимого.
- **FR-012**: Docs-коллекция MUST создаваться при старте сервиса и MUST самовосстанавливаться при отсутствии во время операций записи или удаления.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Для одинакового состояния репозитория и параметров запуска система должна выдавать одинаковые количественные итоги docs-индексации.
- **NFR-002**: Для одинакового запроса и неизменных данных порядок топ-результатов docs-поиска должен быть детерминированным.
- **NFR-003**: Ошибки docs-индексации и docs-поиска должны быть наблюдаемыми и классифицируемыми для диагностики.

### Key Entities *(include if feature involves data)*

- **DocumentationFile**: документ документации с атрибутами пути, состояния обработки, контрольной суммы и времени последнего обновления. Уникальный ключ: нормализованный путь.
- **DocumentationChunk**: индексируемый фрагмент документации с атрибутами источника, позиции в документе и содержимого. Уникальный ключ: `path + stable chunk index`.
- **DocsSearchRequest**: поисковый запрос по документации с параметрами выборки результатов.
- **IndexingRunSummary**: итог выполнения запуска индексирования с количествами обработанных, пропущенных и обновленных документов и причинами пропуска.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В тестовом репозитории со смешанным содержимым 100% markdown-документов доступны для docs-поиска, и 0% результатов docs-поиска указывают на кодовые файлы.
- **SC-002**: Повторный запуск индексирования без изменений не увеличивает количество записей в docs-индексе.
- **SC-003**: Для контрольного набора из 20 docs-запросов не менее 90% запросов возвращают минимум один релевантный результат из документации.
- **SC-004**: Для пяти последовательных повторов одного и того же docs-запроса при неизменных данных состав и порядок первых 5 результатов совпадают.
- **SC-005**: Для репозитория без markdown-документов индексирование и docs-поиск завершаются без падений и возвращают корректный пустой итог.
