# Спецификация фичи: Гибридный поиск в markdown-коллекции

**Feature Branch**: `016-md-hybrid-search`
**Created**: 2026-02-23
**Status**: Draft
**Input**: User description: "Hybrid search (BM25 + vector) только для md коллекции"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Найти релевантный markdown-контент по сложному запросу (Priority: P1)

Пользователь вводит запрос к документации и получает результаты из markdown-коллекции, ранжированные по сочетанию текстового совпадения и смысловой близости, чтобы быстрее находить точные и полезные материалы.

**Why this priority**: Основная ценность фичи в повышении качества поиска именно по markdown-документации.

**Independent Test**: Выполнить набор реалистичных пользовательских запросов к markdown-коллекции и подтвердить, что релевантные материалы стабильно находятся в верхних позициях.

**Acceptance Scenarios**:

1. **Given** markdown-коллекция содержит документы с частичными ключевыми совпадениями и смыслово близкими фрагментами, **When** пользователь выполняет поиск, **Then** в первой странице результатов присутствуют оба типа релевантных материалов.
2. **Given** пользователь задает термин с несколькими формулировками в документации, **When** выполняется поиск, **Then** система возвращает результаты с разными формами выражения этого термина без потери релевантности.

---

### User Story 2 - Ограничить гибридный режим только markdown-областью (Priority: P2)

Владелец продукта хочет, чтобы гибридное ранжирование применялось только к markdown-коллекции, а остальные поисковые сценарии продолжили работать по прежним правилам.

**Why this priority**: Фича должна быть точечно внедрена без регрессий в других поисковых потоках.

**Independent Test**: Сравнить результаты до/после релиза для не-markdown поисков и подтвердить отсутствие изменения поведения.

**Acceptance Scenarios**:

1. **Given** пользователь запускает поиск вне markdown-коллекции, **When** запрос обрабатывается, **Then** результаты формируются по существующей логике без гибридного режима.
2. **Given** пользователь запускает поиск в markdown-коллекции, **When** запрос обрабатывается, **Then** применяется гибридный подход к ранжированию.

---

### User Story 3 - Предсказуемость и прозрачность результата для пользователя (Priority: P3)

Пользователь должен понимать, что отсутствие результатов или низкая релевантность корректно обработаны, и повторять запросы без непредсказуемых скачков в выдаче.

**Why this priority**: Улучшение релевантности бесполезно без стабильного пользовательского опыта.

**Independent Test**: Повторить одинаковые запросы в сопоставимых условиях и проверить стабильность состава и порядка верхних результатов.

**Acceptance Scenarios**:

1. **Given** в markdown-коллекции нет подходящих документов, **When** пользователь выполняет поиск, **Then** система возвращает пустой результат с понятным сообщением, а не ошибку.
2. **Given** пользователь повторяет одинаковый запрос без изменений данных, **When** выдача строится повторно, **Then** топ результатов остается консистентным.

---

### Edge Cases

- Поисковый запрос состоит только из спецсимволов или пробелов.
- В markdown-коллекции очень мало данных (1-2 документа), и ранжирование не должно деградировать в ошибки.
- Запрос содержит термины, которых нет в markdown-коллекции, но есть в других коллекциях.
- Данные markdown-коллекции были недавно обновлены, и результаты должны отражать актуальное состояние без дубликатов.
- Временная недоступность markdown-коллекции должна приводить к контролируемой ошибке с рекомендацией повторить запрос.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать гибридный поиск (комбинация текстовой и смысловой релевантности) для запросов к markdown-коллекции.
- **FR-002**: Гибридный режим MUST применяться только к markdown-коллекции и MUST NOT изменять поведение поиска в других коллекциях.
- **FR-003**: Для каждого поиска в markdown-коллекции система MUST возвращать упорядоченный список результатов с единым итоговым ранжированием.
- **FR-004**: При отсутствии релевантных markdown-документов система MUST возвращать корректный пустой результат без технической ошибки.
- **FR-005**: Система MUST обеспечивать консистентность выдачи: одинаковый запрос к неизменным данным дает сопоставимый топ результатов.
- **FR-006**: Система MUST обрабатывать невалидные или пустые запросы через валидацию пользовательского ввода и понятное сообщение об ошибке.
- **FR-007**: Изменение логики поиска MUST быть отражено в пользовательской документации с явным указанием области действия (только markdown-коллекция).

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Для 95% запросов к markdown-коллекции пользователь MUST получать первые результаты не более чем за 2 секунды при типичной рабочей нагрузке проекта.
- **NFR-002**: Поисковая выдача MUST быть устойчивой к повторным запросам: доля совпадения топ-5 результатов для неизменных данных должна быть не ниже 90%.
- **NFR-003**: Пользовательские сообщения об ошибках MUST быть понятными, без внутренних технических деталей.
- **NFR-004**: Качество выдачи MUST быть проверяемым на контрольном наборе запросов и поддерживать целевой уровень релевантности, согласованный в Success Criteria.

### Key Entities *(include if feature involves data)*

- **SearchQuery**: пользовательская поисковая фраза, контекст поиска, целевая область (markdown-коллекция).
- **MarkdownDocument**: единица контента markdown с заголовком, текстом, метаданными источника и временем последнего обновления.
- **SearchResult**: найденный документ или фрагмент с итоговой позицией, оценкой релевантности и кратким обоснованием попадания в выдачу.
- **CollectionScope**: правило маршрутизации поиска, определяющее, что гибридная логика активируется только для markdown-коллекции.

## Assumptions

- В продукте уже существует отдельная markdown-коллекция, используемая для поиска по документации.
- Пользователь выполняет поиск через текущие интерфейсы продукта без изменения ролей и прав доступа.
- Для проверки качества доступен базовый набор типовых запросов по markdown-документации.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 85% тестовых markdown-запросов возвращают релевантный результат в топ-3 выдачи.
- **SC-002**: Для 95% поисков по markdown-коллекции пользователь видит результаты менее чем за 2 секунды.
- **SC-003**: В 100% контрольных тестов поиск вне markdown-коллекции сохраняет прежнее поведение без изменений ранжирования, вызванных этой фичей.
- **SC-004**: Доля пустых или ошибочных ответов на валидные markdown-запросы не превышает 2% за период приемочного тестирования.
