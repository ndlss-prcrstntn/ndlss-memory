# Phase 0 Research: Hybrid Search (BM25 + Vector) for Markdown Collection

## Decision 1: Fusion strategy for markdown docs retrieval

- Decision: Использовать hybrid-ранжирование как взвешенное объединение двух сигналов (lexical BM25 + vector similarity) на общем пуле кандидатов markdown-коллекции.
- Rationale: Такой подход одновременно покрывает точные текстовые совпадения и семантическую близость, что напрямую улучшает релевантность для документации.
- Alternatives considered:
  - Только vector: отклонено, хуже ловит точные терминологические совпадения.
  - Только BM25: отклонено, хуже работает для перефразированных пользовательских запросов.
  - Каскадный rerank только по top-N одного канала: отклонено, повышает риск потери релевантных кандидатов второго канала.

## Decision 2: Scope enforcement (docs-only)

- Decision: Гибридный режим активируется только для запросов к markdown-коллекции (`/v1/search/docs/query`) и не применяется к non-docs endpoint-ам.
- Rationale: Это соответствует требованию фичи и снижает риск регрессий в существующем поиске по коду и другим коллекциям.
- Alternatives considered:
  - Включить гибридный режим глобально: отклонено из-за выхода за scope и высокого риска изменений в текущем UX.
  - Включать гибрид по флагу в любом endpoint: отклонено на этом этапе, так как усложняет валидацию обратной совместимости.

## Decision 3: Deterministic ranking policy

- Decision: При равенстве итогового hybrid score использовать стабильный tie-break по нормализованному `documentPath`, затем по `chunkIndex`.
- Rationale: Детерминированный порядок критичен для повторяемых тестов и предсказуемого пользовательского поведения.
- Alternatives considered:
  - Недетерминированный порядок при одинаковом score: отклонено, вызывает флак в regression/contract тестах.
  - Tie-break по внутреннему ID хранилища: отклонено, может зависеть от порядка записи/переиндексации.

## Decision 4: Query validation and error semantics

- Decision: Пустые и невалидные запросы отклонять на входе с HTTP 400 и машиночитаемым `errorCode`, не выполняя поиск.
- Rationale: Это уменьшает шумовые запросы, экономит ресурсы и соответствует конституционным требованиям по контрактам ошибок.
- Alternatives considered:
  - Автоматически заменять пустой запрос на wildcard: отклонено, приводит к нерелевантной массовой выдаче.
  - Возвращать 200 с пустым результатом для невалидного ввода: отклонено, ухудшает диагностику клиентской ошибки.

## Decision 5: Compatibility boundary for existing search flows

- Decision: Существующий `POST /v1/search/semantic` и остальные non-docs API сохраняют текущее поведение и формат ответов.
- Rationale: Обратная совместимость является обязательным quality gate и минимизирует риски для текущих интеграций.
- Alternatives considered:
  - Унифицировать docs и semantic search в один endpoint в рамках этой фичи: отклонено, так как расширяет scope и задерживает релиз.

## Decision 6: Quality and observability baseline

- Decision: Для приемки использовать единый набор проверяемых метрик: latency p95, top-3 relevance hit rate, empty/error rate на валидных запросах.
- Rationale: Метрики напрямую связаны с success criteria и дают прозрачные условия релизной проверки.
- Alternatives considered:
  - Оценка качества только экспертным review выдачи: отклонено, недостаточно объективно и плохо автоматизируется.
  - Оценка только по latency: отклонено, не отражает фактическое качество релевантности.
