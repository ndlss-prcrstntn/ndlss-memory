# Research: Базовый Docker Compose стек

## Контекст

Фича: `001-base-docker-compose`
Цель: обеспечить воспроизводимый локальный запуск стека из 3 сервисов и
операционную наблюдаемость первого уровня.

## Решения

### Decision: Единая точка запуска через `docker compose up`
- Rationale: соответствует конституции (воспроизводимость одной командой),
  упрощает onboarding внешних пользователей.
- Alternatives considered:
  - Запуск отдельных сервисов вручную: отклонено как трудно воспроизводимое.
  - Раздельные compose-файлы по сервисам: отклонено как избыточно для MVP.

### Decision: Фиксированный состав сервисов (`qdrant`, `file-indexer`, `mcp-server`)
- Rationale: соблюдение архитектурного ограничения из конституции.
- Alternatives considered:
  - Добавить reverse-proxy на старте: отклонено, не требуется для MVP.
  - Добавить отдельный orchestrator-сервис: отклонено как лишняя сложность.

### Decision: Конфигурация через `.env` + `.env.example`
- Rationale: единый подход к параметрам в локальной среде и простой обмен
  настройками между пользователями.
- Alternatives considered:
  - Жестко зашитые значения в compose: отклонено, снижает переносимость.
  - Платформо-зависимые скрипты без env-файла: отклонено, хуже прозрачность.

### Decision: Qdrant хранит данные в named volume
- Rationale: требование персистентности и устойчивости между перезапусками.
- Alternatives considered:
  - Хранение в bind mount случайного пути: отклонено как менее предсказуемое.
  - Эфемерное хранилище: отклонено из-за потери индекса.

### Decision: Индексатор получает workspace через bind mount и поддерживает оба режима
- Rationale: обеспечивает режимы `full-scan` и `delta-after-commit` без
  изменения архитектуры стека на старте.
- Alternatives considered:
  - Копирование файлов внутрь image на build: отклонено, не подходит для
    инкрементальной работы.

### Decision: Диагностика через контракт REST статуса сервисов
- Rationale: единый, машиночитаемый способ проверить состояние и причины ошибок.
- Alternatives considered:
  - Только `docker compose ps`: отклонено, недостаточно для клиентов MCP/API.
  - Неформальный формат логов без схемы: отклонено как нетестируемое.

### Decision: Базовые security-ограничения для команд MCP
- Rationale: безопасность по конституции требует allowlist, timeout и изоляцию
  уже в дизайне.
- Alternatives considered:
  - Полный shell-доступ в контейнере: отклонено как высокий риск.
  - Отложить безопасность на следующий этап: отклонено как нарушение gate.

## Разрешение неопределенностей

В `plan.md` не осталось `NEEDS CLARIFICATION`. Все критичные решения
зафиксированы и готовы к задачам Phase 2.
