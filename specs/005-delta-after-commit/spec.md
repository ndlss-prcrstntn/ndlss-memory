# Спецификация фичи: Delta-after-commit режим

**Feature Branch**: `005-delta-after-commit`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "Режим Delta-after-commit: интеграция с Git, использование `git diff` для получения измененных файлов, индексация добавленных и измененных файлов, удаление удаленных файлов из Qdrant, обработка rename, фоллбек на full-scan при ошибке."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Индексация только измененных файлов (Priority: P1)

Как пользователь, я хочу запускать индексацию после коммита так, чтобы
обрабатывались только новые и измененные файлы, а не весь проект.

**Why this priority**: Это базовая ценность режима delta-after-commit:
ускорение обработки и сокращение лишних операций.

**Independent Test**: Подготовить репозиторий с набором добавленных, измененных
и неизмененных файлов, запустить delta-индексацию и проверить, что в обработку
попали только добавленные и измененные.

**Acceptance Scenarios**:

1. **Given** есть базовый коммит и в рабочем дереве есть добавленные и
   измененные файлы, **When** запускается delta-after-commit, **Then** система
   ставит в обработку только эти файлы.
2. **Given** с последнего базового состояния нет изменений, **When** запускается
   delta-after-commit, **Then** запуск завершается без записи новых данных.

---

### User Story 2 - Корректная обработка удаления и переименования (Priority: P2)

Как пользователь, я хочу, чтобы удаленные и переименованные файлы правильно
синхронизировались с индексом, чтобы поиск не возвращал устаревшие пути.

**Why this priority**: Без этого индекс быстро теряет актуальность даже при
правильной обработке добавленных и измененных файлов.

**Independent Test**: Удалить один файл и переименовать другой, затем запустить
delta-after-commit и проверить отсутствие старых записей в индексе.

**Acceptance Scenarios**:

1. **Given** файл удален из репозитория, **When** выполняется delta-after-commit,
   **Then** связанные записи удаляются из индекса.
2. **Given** файл переименован без изменения содержимого, **When** выполняется
   delta-after-commit, **Then** в индексе остается только актуальный путь.

---

### User Story 3 - Надежный фоллбек на полный скан (Priority: P3)

Как пользователь, я хочу, чтобы при ошибке Git-диффа система автоматически
переходила в полный скан, чтобы индексация не останавливалась.

**Why this priority**: Это гарантирует устойчивость процесса в нестандартных
репозиториях и снижает ручные восстановительные действия.

**Independent Test**: Смоделировать ошибку получения изменений и проверить, что
запуск автоматически выполняется в режиме полного скана.

**Acceptance Scenarios**:

1. **Given** расчет списка изменений через Git завершился ошибкой, **When**
   запускается delta-after-commit, **Then** система переключается на full-scan и
   фиксирует причину фоллбека в статусе запуска.
2. **Given** Git недоступен в окружении запуска, **When** пользователь запускает
   delta-after-commit, **Then** индексатор выполняет full-scan без остановки
   процесса индексации.

---

### Edge Cases

- Репозиторий не содержит ни одного коммита.
- Базовая ревизия для сравнения недоступна (например, переписана история).
- Один и тот же файл одновременно переименован и изменен.
- В изменениях присутствуют неподдерживаемые или исключенные по паттернам файлы.
- Delta-запуск инициирован во время другого активного запуска индексации.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST определять список изменений репозитория на основе
  сравнения двух состояний Git.
- **FR-002**: Система MUST классифицировать изменения как минимум в категории:
  `added`, `modified`, `deleted`, `renamed`.
- **FR-003**: В режиме delta-after-commit система MUST индексировать только
  файлы из категорий `added` и `modified`.
- **FR-004**: В режиме delta-after-commit система MUST удалять из индекса данные
  для файлов из категории `deleted`.
- **FR-005**: При `renamed` изменении система MUST сохранять в индексе только
  актуальный путь файла и удалять устаревшую привязку.
- **FR-006**: Если расчет изменений через Git невозможен, система MUST
  автоматически переключаться в full-scan для текущего запуска.
- **FR-007**: Система MUST фиксировать в результате запуска фактический режим
  выполнения (`delta-after-commit` или `full-scan-fallback`) и причину выбора.
- **FR-008**: Для delta-after-commit система MUST применять те же правила
  фильтрации и ограничений файлов, что и для полного скана.
- **FR-009**: Повторный запуск delta-after-commit без новых изменений MUST не
  создавать новые записи и не удалять актуальные.
- **FR-010**: Система MUST предоставлять сводку запуска с отдельными счетчиками
  для добавленных, измененных, удаленных, переименованных и пропущенных файлов.
- **FR-011**: Изменения публичного поведения MUST отражаться в документации
  проекта (основной README и quickstart сценарий фичи).

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Для типового изменения до 200 файлов delta-after-commit должен
  завершаться быстрее полного скана на том же наборе данных.
- **NFR-002**: Для 100% запусков с ошибкой Git-диффа система должна выполнять
  автоматический фоллбек без ручного вмешательства.
- **NFR-003**: Для 100% завершенных запусков должна быть доступна сводка с
  машиночитаемыми статусами и причинами.

### Assumptions

- Запуск выполняется в директории, связанной с Git-репозиторием проекта.
- Доступен базовый ориентир сравнения (коммит/ветка), заданный конфигурацией
  или стандартной политикой проекта.
- Удаление и обновление записей в индексе доступны как штатные операции.

### Key Entities *(include if feature involves data)*

- **GitChangeSet**: набор изменений между двумя состояниями репозитория с
  типом изменения и путями файла.
- **DeltaCandidateFile**: файл, выбранный для обработки в delta-режиме, с
  итоговым решением (`index`, `delete`, `skip`) и причиной.
- **DeltaIndexRun**: запуск индексатора с фактическим режимом, причиной
  фоллбека (если есть), статусом и сводными счетчиками.
- **PathTransition**: связь старого и нового пути для сценария переименования.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В не менее чем 95% запусков delta-after-commit обрабатывает только
  файлы, реально измененные между сравниваемыми состояниями.
- **SC-002**: Для 100% удаленных файлов после успешного запуска отсутствуют
  связанные записи в индексе.
- **SC-003**: Для не менее 99% операций переименования в индексе остается только
  один актуальный путь к документу.
- **SC-004**: Для 100% запусков с ошибкой Git-диффа автоматически выполняется
  full-scan-fallback с зафиксированной причиной в статусе запуска.
- **SC-005**: Оператор может определить итог delta-запуска и причину фоллбека
  менее чем за 1 минуту по стандартной сводке запуска.
