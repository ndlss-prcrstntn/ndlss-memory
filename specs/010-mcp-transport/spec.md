# Спецификация фичи: Надежность MCP Индексации

**Feature Branch**: `010-mcp-transport`  
**Created**: 2026-02-22  
**Status**: Draft  
**Input**: User description: "Включить HTTP upsert в mcp-server, разделить внутренний и внешний порт Qdrant, обновить документацию, добавить регрессионные проверки и выпустить патч-релиз."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Гарантированная Запись В Индекс (Priority: P1)

Как пользователь MCP-поиска, я хочу, чтобы запуск индексации через MCP действительно создавал/обновлял векторный индекс, чтобы сразу получать результаты поиска после успешного завершения задачи индексации.

**Why this priority**: Сейчас возможен ложный статус успешной индексации без фактической записи в хранилище, что делает поиск бесполезным.

**Independent Test**: На новом проекте с текстовыми файлами запуск индексации через MCP завершается успешно, после чего коллекция индекса существует и содержит записи.

**Acceptance Scenarios**:

1. **Given** пустое векторное хранилище и новый проект с поддерживаемыми файлами, **When** пользователь запускает индексацию через MCP, **Then** создается коллекция и в ней появляется хотя бы одна запись.
2. **Given** успешный запуск индексации через MCP, **When** пользователь выполняет поиск через MCP, **Then** система возвращает результаты, соответствующие содержимому проиндексированных файлов.

---

### User Story 2 - Независимые Порты Qdrant (Priority: P2)

Как пользователь, который запускает несколько стеков параллельно, я хочу менять внешний порт Qdrant без влияния на внутреннюю связность сервисов, чтобы запуск разных проектов не ломал индексацию и поиск.

**Why this priority**: Конфликт между внешним и внутренним портом приводит к ошибкам подключения и недоступности поиска.

**Independent Test**: При нестандартном внешнем порте Qdrant сервисы продолжают стабильно выполнять индексацию и поиск внутри одного стека.

**Acceptance Scenarios**:

1. **Given** стек запущен с нестандартным внешним портом Qdrant, **When** пользователь запускает индексацию и поиск через MCP, **Then** операции завершаются без ошибок подключения к векторному хранилищу.
2. **Given** два параллельных стека с разными внешними портами, **When** пользователь работает с каждым отдельно, **Then** результаты индексирования и поиска не пересекаются и не блокируют друг друга.

---

### User Story 3 - Прозрачный Онбординг И Регрессионная Защита (Priority: P3)

Как новый пользователь проекта, я хочу получить однозначные инструкции по MCP endpoint и сетевым параметрам, а также автоматические проверки этих сценариев, чтобы не тратить время на ручную диагностику.

**Why this priority**: Документация и тесты предотвращают повторение уже выявленных production-like ошибок.

**Independent Test**: Пользователь следует обновленному quickstart, запускает стек, выполняет индексацию и получает успешный поиск без ручных исправлений конфигурации.

**Acceptance Scenarios**:

1. **Given** обновленная документация, **When** пользователь выполняет quickstart шаги, **Then** MCP endpoint и параметры портов настраиваются корректно с первой попытки.
2. **Given** автоматический прогон quality/regression набора, **When** выполняются сценарии создания коллекции и нестандартного внешнего порта, **Then** оба сценария проходят без регрессий.

---

### Edge Cases

- Индексация запускается, но в рабочей директории нет ни одного поддерживаемого файла.
- Внешний порт Qdrant занят другим процессом до старта стека.
- Векторная коллекция была удалена после успешной индексации и перед поиском.
- Пользователь указывает некорректный MCP endpoint вместо transport endpoint.
- Одновременно выполняются два запуска индексации в одном и том же стеке.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST обеспечивать, что успешный запуск индексации через MCP приводит к фактической записи данных в векторное хранилище.
- **FR-002**: Система MUST автоматически создавать коллекцию индекса при первой записи, если коллекция отсутствует.
- **FR-003**: Система MUST разделять внутренние параметры соединения сервисов и внешний порт публикации векторного хранилища.
- **FR-004**: Все поддерживаемые compose-пресеты MUST сохранять одинаковое корректное поведение индексации и поиска в базовом сценарии запуска.
- **FR-005**: Документация MUST явно описывать корректный MCP transport endpoint и различие между внутренним и внешним портом векторного хранилища.
- **FR-006**: Quality/regression набор MUST содержать проверку, что запуск индексации через MCP создает коллекцию и непустой индекс для индексируемого набора.
- **FR-007**: Quality/regression набор MUST содержать проверку, что нестандартный внешний порт векторного хранилища не нарушает индексацию и поиск.
- **FR-008**: Патч-релиз MUST включать описание исправлений и подтверждение публикации актуальных контейнерных образов.

### Non-Functional Requirements *(mandatory)*

- **NFR-001**: Стандартный quickstart сценарий должен оставаться воспроизводимым на чистой машине с установленным Docker без ручной правки исходного кода.
- **NFR-002**: Ошибки подключения к векторному хранилищу должны быть диагностируемыми и различимыми от пустой выдачи поиска.
- **NFR-003**: Изменения конфигурации сети не должны ухудшать существующую стабильность индексации и поиска при стандартном запуске.

### Assumptions

- Пользователь запускает стек в локальной среде Docker и имеет доступ к портам хоста.
- В рабочей директории присутствуют файлы поддерживаемых типов для демонстрации индексации.
- Патч-релиз публикуется в тот же канал распространения контейнерных образов, что и текущие версии проекта.

### Key Entities *(include if feature involves data)*

- **IngestionRunOutcome**: итог запуска индексации (статус, число обработанных файлов/чанков, число ошибок).
- **VectorCollectionState**: состояние коллекции индекса (существует/отсутствует, число записей).
- **RuntimePortConfig**: конфигурация внутренних и внешних портов для сервисов стека.
- **SmokeRegressionResult**: результат автоматической проверки критичных пользовательских сценариев запуска и поиска.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: В 100% запусков базового smoke-сценария индексации через MCP коллекция индекса создается автоматически при ее отсутствии.
- **SC-002**: В 100% запусков smoke-сценария после успешной индексации количество записей в коллекции больше нуля для непустого тестового набора.
- **SC-003**: В 100% запусков сценария с нестандартным внешним портом векторного хранилища индексация и поиск завершаются без ошибок соединения.
- **SC-004**: Новый пользователь по обновленной документации выполняет запуск, индексацию и первый успешный MCP-поиск менее чем за 10 минут.
