openapi: 3.1.0
info:
  title: Compose Stack Observability API
  version: 0.2.1
  description: >-
    Контракт операционного статуса для startup preflight, readiness summary
    и runtime-наблюдаемости compose-стека.
servers:
  - url: http://localhost:{mcp_port}
    variables:
      mcp_port:
        default: "8080"
paths:
  /health:
    get:
      summary: Проверка доступности API
      operationId: getHealth
      responses:
        "200":
          description: API доступен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthPing"
  /v1/system/status:
    get:
      summary: Получить агрегированный статус compose-стека
      operationId: getSystemStatus
      responses:
        "200":
          description: Успешный ответ со статусом сервисов
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceHealthReport"
  /v1/system/config:
    get:
      summary: Получить эффективную runtime-конфигурацию
      operationId: getRuntimeConfig
      responses:
        "200":
          description: Эффективная конфигурация окружения
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RuntimeConfig"
  /v1/system/startup/readiness:
    get:
      summary: Получить агрегированную startup readiness сводку
      operationId: getStartupReadiness
      responses:
        "200":
          description: Preflight успешно завершен, сервис готов
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartupReadinessSummary"
        "503":
          description: Сервис не готов или preflight завершился ошибкой
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartupFailureReport"
  /v1/system/services/{serviceName}:
    get:
      summary: Получить детальный статус конкретного сервиса
      operationId: getServiceStatus
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ServiceName"
      responses:
        "200":
          description: Детальный статус сервиса
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ComposeServiceStatus"
        "404":
          description: Сервис не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    ServiceName:
      type: string
      enum: [qdrant, file-indexer, mcp-server]
    HealthPing:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok]
        timestamp:
          type: string
          format: date-time
    ComposeServiceStatus:
      type: object
      required: [name, status, lastCheck]
      properties:
        name:
          $ref: "#/components/schemas/ServiceName"
        status:
          type: string
          enum: [starting, healthy, unhealthy, stopped, degraded, down]
        lastCheck:
          type: string
          format: date-time
        details:
          type: string
    ServiceHealthReport:
      type: object
      required: [timestamp, overallStatus, services]
      properties:
        timestamp:
          type: string
          format: date-time
        overallStatus:
          type: string
          enum: [healthy, degraded, down]
        services:
          type: array
          items:
            $ref: "#/components/schemas/ComposeServiceStatus"
        issues:
          type: array
          items:
            type: string
    StartupCheckResult:
      type: object
      required: [checkId, status, severity, message, checkedAt]
      properties:
        checkId:
          type: string
          enum: [qdrant_reachability, workspace_readable, git_available]
        status:
          type: string
          enum: [passed, failed, skipped]
        severity:
          type: string
          enum: [critical, warning, info]
        errorCode:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        action:
          type: string
        checkedAt:
          type: string
          format: date-time
    StartupReadinessSummary:
      type: object
      required:
        - status
        - serviceReadiness
        - workspacePath
        - indexMode
        - mcpEndpoint
        - collectionName
        - preflightChecks
        - checkedAt
      properties:
        status:
          type: string
          enum: [ready]
        serviceReadiness:
          type: object
          required: [qdrant, fileIndexer, mcpServer]
          properties:
            qdrant:
              type: string
            fileIndexer:
              type: string
            mcpServer:
              type: string
        workspacePath:
          type: string
        indexMode:
          type: string
          enum: [full-scan, delta-after-commit]
        mcpEndpoint:
          type: string
        collectionName:
          type: string
        preflightChecks:
          type: array
          items:
            $ref: "#/components/schemas/StartupCheckResult"
        checkedAt:
          type: string
          format: date-time
    StartupFailureReport:
      type: object
      required: [errorCode, message, failedChecks, generatedAt]
      properties:
        errorCode:
          type: string
        message:
          type: string
        failedChecks:
          type: array
          items:
            $ref: "#/components/schemas/StartupCheckResult"
        details:
          type: object
          additionalProperties: true
        recommendedActions:
          type: array
          items:
            type: string
        generatedAt:
          type: string
          format: date-time
    RuntimeConfig:
      type: object
      required:
        - projectName
        - qdrantPort
        - qdrantApiPort
        - mcpPort
        - indexMode
        - indexFileTypes
        - indexExcludePatterns
        - indexMaxFileSizeBytes
        - indexProgressIntervalSeconds
        - commandAllowlist
        - commandTimeoutSeconds
        - startupPreflightEnabled
        - startupPreflightTimeoutSeconds
        - startupReadiness
      properties:
        projectName:
          type: string
        qdrantPort:
          type: integer
          minimum: 1
          maximum: 65535
        qdrantApiPort:
          type: integer
          minimum: 1
          maximum: 65535
        qdrantHost:
          type: string
        mcpPort:
          type: integer
          minimum: 1
          maximum: 65535
        indexMode:
          type: string
          enum: [full-scan, delta-after-commit]
        indexFileTypes:
          type: array
          items:
            type: string
        indexExcludePatterns:
          type: array
          items:
            type: string
        indexMaxFileSizeBytes:
          type: integer
          minimum: 1
        indexProgressIntervalSeconds:
          type: integer
          minimum: 1
        commandAllowlist:
          type: array
          items:
            type: string
        commandTimeoutSeconds:
          type: integer
          minimum: 1
        startupPreflightEnabled:
          type: string
        startupPreflightTimeoutSeconds:
          type: number
        startupPreflightRequireGitForDelta:
          type: string
        startupReadySummaryLogEnabled:
          type: string
        mcpEndpointPath:
          type: string
        startupReadiness:
          oneOf:
            - $ref: "#/components/schemas/StartupReadinessSummary"
            - type: object
              required: [status]
              properties:
                status:
                  type: string
                failureReport:
                  $ref: "#/components/schemas/StartupFailureReport"
    ErrorResponse:
      type: object
      required: [errorCode, message]
      properties:
        errorCode:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
