openapi: 3.1.0
info:
  title: Compose Stack Observability API
  version: 0.2.1
  description: >-
    Контракт операционного статуса для startup preflight, bootstrap первого
    запуска и runtime-наблюдаемости compose-стека.
servers:
  - url: http://localhost:{mcp_port}
    variables:
      mcp_port:
        default: "8080"
paths:
  /health:
    get:
      summary: Проверка доступности API
      operationId: getHealth
      responses:
        "200":
          description: API доступен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthPing"

  /v1/system/status:
    get:
      summary: Получить агрегированный статус compose-стека
      operationId: getSystemStatus
      responses:
        "200":
          description: Успешный ответ со статусом сервисов
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceHealthReport"

  /v1/system/config:
    get:
      summary: Получить эффективную runtime-конфигурацию
      operationId: getRuntimeConfig
      responses:
        "200":
          description: Эффективная конфигурация окружения
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RuntimeConfig"

  /v1/system/startup/readiness:
    get:
      summary: Получить агрегированную startup readiness сводку с bootstrap-статусом
      operationId: getStartupReadiness
      responses:
        "200":
          description: Preflight завершен и доступен bootstrap-статус
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartupReadinessSummary"
        "503":
          description: Сервис не готов или preflight завершился ошибкой
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartupFailureReport"

  /v1/system/services/{serviceName}:
    get:
      summary: Получить детальный статус конкретного сервиса
      operationId: getServiceStatus
      parameters:
        - name: serviceName
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ServiceName"
      responses:
        "200":
          description: Детальный статус сервиса
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ComposeServiceStatus"
        "404":
          description: Сервис не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/indexing/ingestion/jobs/{runId}:
    get:
      summary: Получить статус ingestion run c bootstrap-контекстом
      operationId: getIngestionRunStatus
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Текущий статус run
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionRunStatusWithBootstrap"
        "404":
          description: Run не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/indexing/ingestion/jobs/{runId}/summary:
    get:
      summary: Получить итог ingestion run c bootstrap-контекстом
      operationId: getIngestionRunSummary
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Run завершен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionRunSummaryWithBootstrap"
        "404":
          description: Run не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Run еще не завершен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/indexing/watch/status:
    get:
      summary: Получить текущее состояние watch-режима
      operationId: getWatchStatus
      responses:
        "200":
          description: Актуальный статус watch-loop
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchStatusResponse"
        "503":
          description: Watch режим недоступен или не запущен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/indexing/watch/summary:
    get:
      summary: Получить сводку последнего окна обработки watch-событий
      operationId: getWatchSummary
      responses:
        "200":
          description: Сводка последней обработки watch-событий
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchSummaryResponse"
        "404":
          description: Сводка пока недоступна
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Watch режим недоступен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    ServiceName:
      type: string
      enum: [qdrant, file-indexer, mcp-server]

    HealthPing:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok]
        timestamp:
          type: string
          format: date-time

    ComposeServiceStatus:
      type: object
      required: [name, status, lastCheck]
      properties:
        name:
          $ref: "#/components/schemas/ServiceName"
        status:
          type: string
          enum: [starting, healthy, unhealthy, stopped, degraded, down]
        lastCheck:
          type: string
          format: date-time
        details:
          type: string

    ServiceHealthReport:
      type: object
      required: [timestamp, overallStatus, services]
      properties:
        timestamp:
          type: string
          format: date-time
        overallStatus:
          type: string
          enum: [healthy, degraded, down]
        services:
          type: array
          items:
            $ref: "#/components/schemas/ComposeServiceStatus"
        issues:
          type: array
          items:
            type: string

    StartupCheckResult:
      type: object
      required: [checkId, status, severity, message, checkedAt]
      properties:
        checkId:
          type: string
          enum: [qdrant_reachability, workspace_readable, git_available]
        status:
          type: string
          enum: [passed, failed, skipped]
        severity:
          type: string
          enum: [critical, warning, info]
        errorCode:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        action:
          type: string
        checkedAt:
          type: string
          format: date-time

    BootstrapStatus:
      type: object
      required: [trigger, decision, status, workspaceKey, checkedAt]
      properties:
        trigger:
          type: string
          enum: [auto-startup, manual]
        decision:
          type: string
          enum: [run, skip-already-completed, retry-failed]
        status:
          type: string
          enum: [ready, running, failed, skipped]
        workspaceKey:
          type: string
        runId:
          type: string
        reason:
          type: string
        checkedAt:
          type: string
          format: date-time

    CollectionReadinessSnapshot:
      type: object
      required: [collectionName, exists, pointCount, checkedAt]
      properties:
        collectionName:
          type: string
        exists:
          type: boolean
        pointCount:
          type: integer
          minimum: 0
        checkedAt:
          type: string
          format: date-time

    StartupReadinessSummary:
      type: object
      required:
        - status
        - serviceReadiness
        - workspacePath
        - indexMode
        - mcpEndpoint
        - collectionName
        - preflightChecks
        - checkedAt
        - bootstrap
        - collection
      properties:
        status:
          type: string
          enum: [ready, running, failed, skipped]
        serviceReadiness:
          type: object
          required: [qdrant, fileIndexer, mcpServer]
          properties:
            qdrant:
              type: string
            fileIndexer:
              type: string
            mcpServer:
              type: string
        workspacePath:
          type: string
        indexMode:
          type: string
          enum: [full-scan, delta-after-commit, watch]
        mcpEndpoint:
          type: string
        collectionName:
          type: string
        preflightChecks:
          type: array
          items:
            $ref: "#/components/schemas/StartupCheckResult"
        bootstrap:
          $ref: "#/components/schemas/BootstrapStatus"
        collection:
          $ref: "#/components/schemas/CollectionReadinessSnapshot"
        bootstrapFailure:
          $ref: "#/components/schemas/BootstrapFailureReport"
        checkedAt:
          type: string
          format: date-time

    BootstrapFailureReport:
      type: object
      required: [errorCode, message]
      properties:
        errorCode:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        recommendedActions:
          type: array
          items:
            type: string

    StartupFailureReport:
      type: object
      required: [errorCode, message, failedChecks, generatedAt]
      properties:
        errorCode:
          type: string
        message:
          type: string
        failedChecks:
          type: array
          items:
            $ref: "#/components/schemas/StartupCheckResult"
        details:
          type: object
          additionalProperties: true
        recommendedActions:
          type: array
          items:
            type: string
        generatedAt:
          type: string
          format: date-time

    IngestionRunStatusWithBootstrap:
      type: object
      required:
        - runId
        - status
        - totalFiles
        - totalChunks
        - embeddedChunks
        - failedChunks
        - bootstrap
        - collection
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [queued, running, completed, failed, partial]
        totalFiles:
          type: integer
          minimum: 0
        totalChunks:
          type: integer
          minimum: 0
        embeddedChunks:
          type: integer
          minimum: 0
        failedChunks:
          type: integer
          minimum: 0
        retryCount:
          type: integer
          minimum: 0
        lastEventAt:
          type: string
          format: date-time
        errorCode:
          type: string
        errorMessage:
          type: string
        bootstrap:
          $ref: "#/components/schemas/BootstrapStatus"
        collection:
          $ref: "#/components/schemas/CollectionReadinessSnapshot"

    IngestionRunSummaryWithBootstrap:
      type: object
      required:
        - runId
        - status
        - totalFiles
        - totalChunks
        - embeddedChunks
        - failedChunks
        - startedAt
        - finishedAt
        - bootstrap
        - collection
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [completed, failed, partial]
        totalFiles:
          type: integer
          minimum: 0
        totalChunks:
          type: integer
          minimum: 0
        embeddedChunks:
          type: integer
          minimum: 0
        failedChunks:
          type: integer
          minimum: 0
        retryCount:
          type: integer
          minimum: 0
        startedAt:
          type: string
          format: date-time
        finishedAt:
          type: string
          format: date-time
        errorCode:
          type: string
        errorMessage:
          type: string
        metadataCoverage:
          type: object
          additionalProperties:
            type: number
        bootstrap:
          $ref: "#/components/schemas/BootstrapStatus"
        collection:
          $ref: "#/components/schemas/CollectionReadinessSnapshot"

    WatchStatusResponse:
      type: object
      required:
        - mode
        - state
        - workspacePath
        - startedAt
        - lastHeartbeatAt
        - queueDepth
        - processedEvents
        - failedEvents
        - retryCount
      properties:
        mode:
          type: string
          enum: [watch]
        state:
          type: string
          enum: [starting, running, recovering, failed, stopped]
        workspacePath:
          type: string
        startedAt:
          type: string
          format: date-time
        lastHeartbeatAt:
          type: string
          format: date-time
        lastEventAt:
          type: string
          format: date-time
        queueDepth:
          type: integer
          minimum: 0
        processedEvents:
          type: integer
          minimum: 0
        failedEvents:
          type: integer
          minimum: 0
        retryCount:
          type: integer
          minimum: 0
        lastErrorCode:
          type: string
        lastErrorMessage:
          type: string
        backoffSeconds:
          type: number
          minimum: 0

    WatchSummaryResponse:
      type: object
      required:
        - summaryId
        - status
        - windowStartedAt
        - windowFinishedAt
        - affectedFiles
        - indexedFiles
        - deletedRecords
        - skippedFiles
        - failedFiles
      properties:
        summaryId:
          type: string
        status:
          type: string
          enum: [completed, partial, failed]
        windowStartedAt:
          type: string
          format: date-time
        windowFinishedAt:
          type: string
          format: date-time
        affectedFiles:
          type: array
          items:
            type: string
        indexedFiles:
          type: integer
          minimum: 0
        deletedRecords:
          type: integer
          minimum: 0
        skippedFiles:
          type: integer
          minimum: 0
        failedFiles:
          type: integer
          minimum: 0
        reasonBreakdown:
          type: array
          items:
            type: object
            required: [code, count]
            properties:
              code:
                type: string
              count:
                type: integer
                minimum: 1
        generatedAt:
          type: string
          format: date-time

    RuntimeConfig:
      type: object
      required:
        - projectName
        - qdrantPort
        - qdrantApiPort
        - mcpPort
        - indexMode
        - startupReadiness
      properties:
        projectName:
          type: string
        qdrantPort:
          type: integer
        qdrantApiPort:
          type: integer
        qdrantHost:
          type: string
        mcpPort:
          type: integer
        indexMode:
          type: string
          enum: [full-scan, delta-after-commit, watch]
        watchPollIntervalSeconds:
          type: integer
          minimum: 1
        watchCoalesceWindowSeconds:
          type: integer
          minimum: 1
        watchReconcileIntervalSeconds:
          type: integer
          minimum: 1
        watchRetryMaxAttempts:
          type: integer
          minimum: 1
        watchRetryBaseDelaySeconds:
          type: number
          minimum: 0
        watchRetryMaxDelaySeconds:
          type: number
          minimum: 0
        watchHeartbeatIntervalSeconds:
          type: integer
          minimum: 1
        watchMaxEventsPerCycle:
          type: integer
          minimum: 1
        watchStatus:
          $ref: "#/components/schemas/WatchStatusResponse"
        watchSummary:
          $ref: "#/components/schemas/WatchSummaryResponse"
        startupPreflightEnabled:
          type: string
        startupPreflightTimeoutSeconds:
          type: number
        startupReadySummaryLogEnabled:
          type: string
        bootstrapAutoIngestOnStart:
          type: string
        bootstrapRetryFailedOnStart:
          type: string
        bootstrapStateCollection:
          type: string
        mcpEndpointPath:
          type: string
        bootstrap:
          $ref: "#/components/schemas/BootstrapStatus"
        collection:
          $ref: "#/components/schemas/CollectionReadinessSnapshot"
        startupReadiness:
          oneOf:
            - $ref: "#/components/schemas/StartupReadinessSummary"
            - type: object
              required: [status]
              properties:
                status:
                  type: string
                failureReport:
                  $ref: "#/components/schemas/StartupFailureReport"

    ErrorResponse:
      type: object
      required: [errorCode, message]
      properties:
        errorCode:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
