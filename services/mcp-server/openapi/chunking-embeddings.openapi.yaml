openapi: 3.1.0
info:
  title: Chunking and Embeddings Ingestion API
  version: 0.1.0
  description: Runtime contract for ingestion job control and summary reporting.
servers:
  - url: http://localhost:{mcp_port}
    variables:
      mcp_port:
        default: "8080"
paths:
  /v1/indexing/ingestion/jobs:
    post:
      summary: Start ingestion run
      operationId: startIngestionJob
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartIngestionRequest"
      responses:
        "202":
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartIngestionResponse"
        "400":
          description: Invalid run limits configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Another run is active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/indexing/ingestion/jobs/{runId}:
    get:
      summary: Get run status
      operationId: getIngestionStatus
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Run status payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionRunStatus"
        "404":
          description: Run not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/indexing/ingestion/jobs/{runId}/summary:
    get:
      summary: Get run summary
      operationId: getIngestionSummary
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Completed run summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestionRunSummary"
        "404":
          description: Run not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Run still active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/indexing/docs/jobs:
    post:
      summary: Start docs-only indexing run
      operationId: startDocsIndexingJob
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartDocsIndexingRequest"
      responses:
        "202":
          description: Docs run accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartIngestionResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Another run is active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/indexing/docs/jobs/{runId}/summary:
    get:
      summary: Get docs-only indexing summary
      operationId: getDocsIndexingSummary
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Completed docs run summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocsRunSummary"
        "404":
          description: Run not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Run still active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    StartDocsIndexingRequest:
      type: object
      properties:
        workspacePath:
          type: string
        includeExtensions:
          type: array
          items:
            type: string
        chunkSize:
          type: integer
          minimum: 1
        chunkOverlap:
          type: integer
          minimum: 0
        retryMaxAttempts:
          type: integer
          minimum: 1
        maxTraversalDepth:
          type: integer
          minimum: 0
          nullable: true
        maxFilesPerRun:
          type: integer
          minimum: 1
          nullable: true
    StartIngestionRequest:
      type: object
      properties:
        workspacePath:
          type: string
        chunkSize:
          type: integer
          minimum: 1
        chunkOverlap:
          type: integer
          minimum: 0
        retryMaxAttempts:
          type: integer
          minimum: 1
        maxTraversalDepth:
          type: integer
          minimum: 0
          nullable: true
        maxFilesPerRun:
          type: integer
          minimum: 1
          nullable: true
    RunLimits:
      type: object
      required: [maxTraversalDepth, maxFilesPerRun]
      properties:
        maxTraversalDepth:
          type: integer
          minimum: 0
          nullable: true
        maxFilesPerRun:
          type: integer
          minimum: 1
          nullable: true
    SkipReasonAggregate:
      type: object
      required: [code, count]
      properties:
        code:
          type: string
          enum:
            - LIMIT_DEPTH_EXCEEDED
            - LIMIT_MAX_FILES_REACHED
        count:
          type: integer
          minimum: 0
    StartIngestionResponse:
      type: object
      required: [runId, status, acceptedAt]
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [queued, running]
        acceptedAt:
          type: string
          format: date-time
    IngestionRunStatus:
      type: object
      required: [runId, status, appliedLimits, totalFiles, totalChunks, embeddedChunks, failedChunks, retryCount, lastEventAt]
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [queued, running, completed, failed, partial]
        appliedLimits:
          $ref: "#/components/schemas/RunLimits"
        totalFiles:
          type: integer
          minimum: 0
        totalChunks:
          type: integer
          minimum: 0
        embeddedChunks:
          type: integer
          minimum: 0
        failedChunks:
          type: integer
          minimum: 0
        retryCount:
          type: integer
          minimum: 0
        lastEventAt:
          type: string
          format: date-time
        errorCode:
          type: string
        errorMessage:
          type: string
    IngestionRunSummary:
      type: object
      required: [runId, status, appliedLimits, skipBreakdown, totalFiles, totalChunks, embeddedChunks, failedChunks, retryCount, startedAt, finishedAt, metadataCoverage]
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [completed, failed, partial]
        appliedLimits:
          $ref: "#/components/schemas/RunLimits"
        skipBreakdown:
          type: array
          items:
            $ref: "#/components/schemas/SkipReasonAggregate"
        totalFiles:
          type: integer
          minimum: 0
        totalChunks:
          type: integer
          minimum: 0
        embeddedChunks:
          type: integer
          minimum: 0
        failedChunks:
          type: integer
          minimum: 0
        retryCount:
          type: integer
          minimum: 0
        startedAt:
          type: string
          format: date-time
        finishedAt:
          type: string
          format: date-time
        metadataCoverage:
          type: object
          required: [path, fileName, fileType, contentHash, timestamp]
          properties:
            path:
              type: number
            fileName:
              type: number
            fileType:
              type: number
            contentHash:
              type: number
            timestamp:
              type: number
    DocsRunTotals:
      type: object
      required: [processedDocuments, indexedDocuments, updatedDocuments, skippedDocuments, deletedDocuments]
      properties:
        processedDocuments:
          type: integer
          minimum: 0
        indexedDocuments:
          type: integer
          minimum: 0
        updatedDocuments:
          type: integer
          minimum: 0
        skippedDocuments:
          type: integer
          minimum: 0
        deletedDocuments:
          type: integer
          minimum: 0
    DocsRunSummary:
      type: object
      required: [runId, status, totals, skipBreakdown, startedAt, finishedAt]
      properties:
        runId:
          type: string
        status:
          type: string
          enum: [completed, failed, partial]
        totals:
          $ref: "#/components/schemas/DocsRunTotals"
        appliedLimits:
          $ref: "#/components/schemas/RunLimits"
        skipBreakdown:
          type: array
          items:
            $ref: "#/components/schemas/SkipReasonAggregate"
        startedAt:
          type: string
          format: date-time
        finishedAt:
          type: string
          format: date-time
    ErrorResponse:
      type: object
      required: [errorCode, message]
      properties:
        errorCode:
          type: string
        message:
          type: string
        details:
          type: string
